# =============================================
# ğŸ“Œ ì„í¬íŠ¸ì²´ì»¤ (v250723)
# ì‘ì„±ì: ì„œê¸°ëŒ€
# ëª©ì : ìˆ˜ìš©ê°€ ë‹¨ë§ê¸° ë“±ë¡ìš© ì—‘ì…€ íŒŒì¼ì„ SQL VALUES êµ¬ë¬¸ìœ¼ë¡œ ìë™ ë³€í™˜
# ì£¼ìš” ê¸°ëŠ¥:
#   - ì—‘ì…€ íŒŒì¼ ì„ íƒ ì°½ ì œê³µ
#   - ì •í•´ì§„ 20ê°œ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° íŒŒì‹±
#   - ì„±ê³µ/ì‹¤íŒ¨ í•­ëª© ìˆ˜ ì§‘ê³„
#   - ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë° SQL VALUES êµ¬ë¬¸ ì¶œë ¥
#   - ê¸´ í…ìŠ¤íŠ¸ë¥¼ ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì¶œë ¥
#   - ìœ íš¨ì„± ê²€ì‚¬ CASE ë„˜ë²„ë§ ì§€ì›
#   - í”„ë¡œê·¸ë¨ ë²„ì „: v250723
# =============================================

import gspread
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime
from tkinter import ttk
import psycopg2
from psycopg2 import Error
import re

# ğŸ“Œ PostgreSQL DB ì—°ê²° ì •ë³´
DB_CONFIG = {
    'host': '10.241.240.219',
    'port': 5433,
    'database': 'mars_icbm',
    'user': 'mars_icbm',
    'password': ''  # ë¹„ë°€ë²ˆí˜¸ëŠ” ì‹¤í–‰ ì‹œ ì…ë ¥ë°›ê±°ë‚˜ ì„¤ì • í•„ìš”
}

# ğŸ“Œ ì—‘ì…€ ì»¬ëŸ¼ëª… ì •ì˜ (20ê°œ í•­ëª©)
COLUMNS = [
    'ìˆ˜ìš©ê°€ëª…', 'ìˆ˜ìš©ê°€ë²ˆí˜¸', 'êµ¬ì£¼ì†Œ', 'ì‹ ì£¼ì†Œ', 'ê²½ë„', 'ìœ„ë„', 'ì—…ì¢…', 'ì†Œì†',
    'ë¸”ë¡', 'ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸', 'ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„', 'ê²€ì¹¨ì›', 'ê²€ì¹¨ì¼', 'ê³„ëŸ‰ê¸°ë²ˆí˜¸',
    'êµ¬ê²½', 'í†µì‹ ', 'ë‹¨ë§ ë¶€ë²ˆí˜¸', 'ë‹¨ë§ ì£¼ë²ˆí˜¸', 'ë‹¨ë§ íšŒì‚¬', 'ë‹¨ë§ ì„¤ì¹˜ì¼'
]

# ğŸ“Œ DB ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ê°„ë‹¨í•œ ì¿¼ë¦¬ ì‹¤í–‰
def test_db_connection():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²° ì„¤ì • (ë¹„ë°€ë²ˆí˜¸ í¬í•¨)
        db_config = DB_CONFIG.copy()
        db_config['password'] = db_password
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬
        cursor.execute("SELECT version();")
        db_version = cursor.fetchone()
        
        # í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ
        cursor.execute("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            ORDER BY table_name 
            LIMIT 10;
        """)
        tables = cursor.fetchall()
        
        # ê²°ê³¼ ì¶œë ¥
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)
        result_text.insert(tk.END, "âœ… DB ì—°ê²° ì„±ê³µ!\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ PostgreSQL ë²„ì „:\n{db_version[0]}\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ í…Œì´ë¸” ëª©ë¡ (ìµœëŒ€ 10ê°œ):\n")
        for idx, table in enumerate(tables, 1):
            result_text.insert(tk.END, f"{idx}. {table[0]}\n")
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("DB ì—°ê²° ì„±ê³µ", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
        
    except Error as e:
        messagebox.showerror("DB ì—°ê²° ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘ ì¡°íšŒ í•¨ìˆ˜ (ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ ìë™ ê°ì§€, ë‹¤ì¤‘ ì…ë ¥ ì§€ì›)
def search_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸° (Text ìœ„ì ¯ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹± (ì¤„ë°”ê¿ˆ, ì‰¼í‘œ, ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²° ì„¤ì •
        db_config = DB_CONFIG.copy()
        db_config['password'] = db_password
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        all_results = []
        
        # ë‹¨ë§ë²ˆí˜¸ë¡œ ì¡°íšŒ
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            query = f"""
                SELECT c.admin_no, d.dev_no
                FROM public.tb_m1_cmap_device d
                JOIN public.tb_m1_info_point p ON d.point_sq = p.point_sq
                JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                WHERE d.dev_no IN ({placeholders});
            """
            cursor.execute(query, device_nos)
            all_results.extend(cursor.fetchall())
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ì¡°íšŒ
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            query = f"""
                SELECT c.admin_no, d.dev_no
                FROM public.tb_m1_cmap_device d
                JOIN public.tb_m1_info_point p ON d.point_sq = p.point_sq
                JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                WHERE c.admin_no IN ({placeholders});
            """
            cursor.execute(query, admin_nos)
            all_results.extend(cursor.fetchall())
        
        # ê²°ê³¼ ì¶œë ¥
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)
        result_text.insert(tk.END, f"ğŸ” ë§¤í•‘ ì¡°íšŒ ê²°ê³¼ (ì´ {len(search_values)}ê°œ ê²€ìƒ‰)\n")
        result_text.insert(tk.END, f"   - ë‹¨ë§ë²ˆí˜¸: {len(device_nos)}ê°œ\n")
        result_text.insert(tk.END, f"   - ìˆ˜ìš©ê°€ë²ˆí˜¸: {len(admin_nos)}ê°œ\n")
        result_text.insert(tk.END, "="*80 + "\n\n")
        
        if all_results:
            result_text.insert(tk.END, f"âœ… {len(all_results)}ê°œì˜ ë§¤í•‘ ë°œê²¬\n\n")
            result_text.insert(tk.END, f"{'ìˆ˜ìš©ê°€ë²ˆí˜¸':<30} {'ë‹¨ë§ë²ˆí˜¸':<15}\n")
            result_text.insert(tk.END, "-"*80 + "\n")
            for admin_no, dev_no in all_results:
                result_text.insert(tk.END, f"{admin_no:<30} {dev_no:<15}\n")
        else:
            result_text.insert(tk.END, "âŒ ë§¤í•‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n")
        
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
    except Error as e:
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘í•´ì œ í•¨ìˆ˜ (ë‹¨ë§ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ ì—°ê²° í•´ì œ)
def unlink_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹±
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # í™•ì¸ ë©”ì‹œì§€
        if not messagebox.askyesno("ë§¤í•‘í•´ì œ í™•ì¸", f"{len(search_values)}ê°œì˜ ë§¤í•‘ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\npoint_sqë¥¼ NULLë¡œ ì„¤ì •í•©ë‹ˆë‹¤."):
            return
        
        # DB ì—°ê²° ì„¤ì •
        db_config = DB_CONFIG.copy()
        db_config['password'] = db_password
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        unlinked_count = 0
        
        # íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device DISABLE TRIGGER ALL;")
        
        # ë‹¨ë§ë²ˆí˜¸ë¡œ ë§¤í•‘í•´ì œ (point_sqë¥¼ NULLë¡œ ì„¤ì •)
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            query = f"""
                UPDATE public.tb_m1_cmap_device
                SET point_sq = NULL
                WHERE dev_no IN ({placeholders});
            """
            cursor.execute(query, device_nos)
            unlinked_count += cursor.rowcount
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë§¤í•‘í•´ì œ (í•´ë‹¹ ìˆ˜ìš©ê°€ì˜ ëª¨ë“  ë‹¨ë§ ë§¤í•‘ í•´ì œ)
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            query = f"""
                WITH point_to_delete AS (
                    SELECT p.point_sq
                    FROM public.tb_m1_info_point p
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no IN ({placeholders})
                )
                UPDATE public.tb_m1_cmap_device
                SET point_sq = NULL
                WHERE point_sq IN (SELECT point_sq FROM point_to_delete);
            """
            cursor.execute(query, admin_nos)
            unlinked_count += cursor.rowcount
        
        # íŠ¸ë¦¬ê±° í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        connection.commit()
        
        # ê²°ê³¼ ì¶œë ¥
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)
        result_text.insert(tk.END, f"ğŸ—‘ï¸ ë§¤í•‘í•´ì œ ì™„ë£Œ\n")
        result_text.insert(tk.END, "="*80 + "\n\n")
        result_text.insert(tk.END, f"âœ… {unlinked_count}ê°œì˜ ë§¤í•‘ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ ì²˜ë¦¬ëœ í•­ëª©:\n")
        result_text.insert(tk.END, f"   - ë‹¨ë§ë²ˆí˜¸: {len(device_nos)}ê°œ\n")
        result_text.insert(tk.END, f"   - ìˆ˜ìš©ê°€ë²ˆí˜¸: {len(admin_nos)}ê°œ\n")
        result_text.insert(tk.END, f"\nğŸ’¡ point_sqê°€ NULLë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.\n")
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("ë§¤í•‘í•´ì œ ì™„ë£Œ", f"{unlinked_count}ê°œì˜ ë§¤í•‘ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Error as e:
        # ì—ëŸ¬ ë°œìƒ ì‹œ íŠ¸ë¦¬ê±° ì¬í™œì„±í™” ì‹œë„
        try:
            cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
            connection.commit()
        except:
            pass
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘ì›ë³µ í•¨ìˆ˜ (ë°±ì—… í…Œì´ë¸”ì—ì„œ ë§¤í•‘ ë³µì›)
def restore_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹±
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # í™•ì¸ ë©”ì‹œì§€
        if not messagebox.askyesno("ë§¤í•‘ì›ë³µ í™•ì¸", f"{len(search_values)}ê°œì˜ ë§¤í•‘ì„ ì›ë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°±ì—… í…Œì´ë¸”ì—ì„œ ë³µì›í•©ë‹ˆë‹¤."):
            return
        
        # DB ì—°ê²° ì„¤ì •
        db_config = DB_CONFIG.copy()
        db_config['password'] = db_password
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        restored_count = 0
        
        # ë‹¨ë§ë²ˆí˜¸ë¡œ ë§¤í•‘ì›ë³µ (ë°±ì—… í…Œì´ë¸”ì—ì„œ ë³µì›)
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            query = f"""
                INSERT INTO public.tb_m1_cmap_device (dev_no, point_sq, reg_dt)
                SELECT dev_no, point_sq, reg_dt
                FROM public.tb_m1_cmap_device_backup 
                WHERE dev_no IN ({placeholders})
                AND NOT EXISTS (
                    SELECT 1 FROM public.tb_m1_cmap_device d 
                    WHERE d.dev_no = tb_m1_cmap_device_backup.dev_no
                );
            """
            cursor.execute(query, device_nos)
            restored_count += cursor.rowcount
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë§¤í•‘ì›ë³µ
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            query = f"""
                INSERT INTO public.tb_m1_cmap_device (dev_no, point_sq, reg_dt)
                SELECT b.dev_no, b.point_sq, b.reg_dt
                FROM public.tb_m1_cmap_device_backup b
                JOIN public.tb_m1_info_point p ON b.point_sq = p.point_sq
                JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                WHERE c.admin_no IN ({placeholders})
                AND NOT EXISTS (
                    SELECT 1 FROM public.tb_m1_cmap_device d 
                    WHERE d.dev_no = b.dev_no
                );
            """
            cursor.execute(query, admin_nos)
            restored_count += cursor.rowcount
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        connection.commit()
        
        # ê²°ê³¼ ì¶œë ¥
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)
        result_text.insert(tk.END, f"ğŸ”„ ë§¤í•‘ì›ë³µ ì™„ë£Œ\n")
        result_text.insert(tk.END, "="*80 + "\n\n")
        result_text.insert(tk.END, f"âœ… {restored_count}ê°œì˜ ë§¤í•‘ì´ ì›ë³µë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ ì²˜ë¦¬ëœ í•­ëª©:\n")
        result_text.insert(tk.END, f"   - ë‹¨ë§ë²ˆí˜¸: {len(device_nos)}ê°œ\n")
        result_text.insert(tk.END, f"   - ìˆ˜ìš©ê°€ë²ˆí˜¸: {len(admin_nos)}ê°œ\n")
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("ë§¤í•‘ì›ë³µ ì™„ë£Œ", f"{restored_count}ê°œì˜ ë§¤í•‘ì´ ì›ë³µë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Error as e:
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ì—‘ì…€ íŒŒì¼ì„ ì½ê³  SQL VALUES êµ¬ë¬¸ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
def generate_sql_from_excel():
    # íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    file_path = filedialog.askopenfilename(title="ì—‘ì…€ íŒŒì¼ ì„ íƒ", filetypes=[("Excel files", "*.xlsx *.xls")])
    if not file_path:
        messagebox.showwarning("íŒŒì¼ ì„ íƒ", "íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì½¤ë³´ë°•ìŠ¤ì—ì„œ ì„ íƒëœ ê³„ì •ëª…ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°€ì ¸ì˜¤ê¸°
    idx = site_combobox.current()
    if idx < 0:
        messagebox.showwarning("ê³„ì •ëª… ì„ íƒ", "ë¨¼ì € ê³„ì •ëª…ì„ ì„ íƒí•˜ì„¸ìš”.")
        return
    try:
        selected_num_len = int(filtered_df.iloc[idx]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´'])
    except Exception:
        messagebox.showerror("ê³„ì •ëª… ì˜¤ë¥˜", "ì„ íƒí•œ ê³„ì •ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ ê°€ì ¸ì˜¤ê¸°
    company_value = company_entry.get().strip()
    if not company_value:
        messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return
    try:
        company_sq = int(company_value)
    except ValueError:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì€ ì •ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
        return

    try:
        # ì—‘ì…€ ë°ì´í„°í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê³µë°± ì±„ì›€
        df = pd.read_excel(file_path, dtype=str).fillna('')
        df = df.iloc[:, 1:1+len(COLUMNS)]  # ì²« ì—´ ì œì™¸ í›„ 20ì—´ë§Œ ì„ íƒ
        df.columns = COLUMNS

        # â–¶ ì¤‘ë³µ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë¯¸ë¦¬ ì§‘ê³„
        admin_no_counts = df['ìˆ˜ìš©ê°€ë²ˆí˜¸'].value_counts()
        duplicated_admin_nos = set(admin_no_counts[admin_no_counts > 1].index)

        values_list = []
        success_count = 0
        fail_count = 0
        success_admin_no_list = []  # ì„±ê³µí•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ì €ì¥

        # ê° í–‰ ë°˜ë³µ ì²˜ë¦¬
        validation_cases = [
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ë²ˆí˜¸']) == selected_num_len, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ë¶ˆì¼ì¹˜"),
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ ê²€ì‚¬", lambda row: row['ìˆ˜ìš©ê°€ë²ˆí˜¸'] not in duplicated_admin_nos, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ"),
            ("ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸']) < 14, "ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ 13ìë¦¬ ì´ˆê³¼"),
            
        ]

        for idx_row, row in df.iterrows():
            try:
                for case_num, (desc, check_func, err_msg) in enumerate(validation_cases, 1):
                    if not check_func(row):
                        raise ValueError(f"[CASE #{case_num}] {err_msg} (ê°’: {row['ìˆ˜ìš©ê°€ë²ˆí˜¸']})")
                # ìˆ«ì ë³€í™˜ì´ í•„ìš”í•œ ì»¬ëŸ¼ì— ëŒ€í•´ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
                def safe_float(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return float(val)
                def safe_int(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return int(float(val))
                values = (
                    row['ìˆ˜ìš©ê°€ëª…'],
                    row['ìˆ˜ìš©ê°€ë²ˆí˜¸'],
                    row['êµ¬ì£¼ì†Œ'],
                    row['ì‹ ì£¼ì†Œ'],
                    safe_float(row['ê²½ë„'], 'ê²½ë„'),
                    safe_float(row['ìœ„ë„'], 'ìœ„ë„'),
                    row['ì—…ì¢…'],
                    company_sq,
                    row['ë¸”ë¡'],
                    row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸'],
                    row['ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„'],
                    row['ê²€ì¹¨ì›'],
                    safe_int(row['ê²€ì¹¨ì¼'], 'ê²€ì¹¨ì¼'),
                    row['ê³„ëŸ‰ê¸°ë²ˆí˜¸'],
                    safe_int(row['êµ¬ê²½'], 'êµ¬ê²½'),
                    row['í†µì‹ '],
                    row['ë‹¨ë§ ë¶€ë²ˆí˜¸'],
                    row['ë‹¨ë§ ì£¼ë²ˆí˜¸'],
                    company_sq,
                    f"{pd.to_datetime(row['ë‹¨ë§ ì„¤ì¹˜ì¼']).date()}"
                )
                # SQL VALUES ë¬¸ìì—´ í¬ë§·íŒ…
                formatted = "('{}', '{}', '{}', '{}', {}, {}, '{}', {}, '{}', '{}', '{}', '{}', {}, '{}', {}, '{}', '{}', '{}', {}, '{}'::timestamp)".format(*values)
                values_list.append(formatted)
                success_admin_no_list.append(row['ìˆ˜ìš©ê°€ë²ˆí˜¸'])
                success_count += 1
            except Exception as e:
                values_list.append(f"-- [ERROR #{idx_row+1}] {e}")
                fail_count += 1

        # ê²°ê³¼ ì¶œë ¥ì°½ ì´ˆê¸°í™” ë° ê²°ê³¼ ì‚½ì…
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)

        # âœ… ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë¨¼ì € ì¶œë ¥
        result_text.insert(tk.END, "-- âœ… ì„í¬íŠ¸ì „ ì¡°íšŒí•  ìˆ˜ìš©ê°€ëª©ë¡\n")
        result_text.insert(tk.END, ",\n".join(f"'{x}'" for x in success_admin_no_list) + "\n\n")

        # âœ… ì„±ê³µ/ì‹¤íŒ¨ í†µê³„ ì¶œë ¥
        result_text.insert(tk.END, f"-- ì´ {len(df)}ê°œ ì¤‘ {success_count}ê°œ ì„±ê³µ, {fail_count}ê°œ ì‹¤íŒ¨\n\n")

        # âœ… SQL VALUES ì¶œë ¥
        result_text.insert(tk.END, ",\n".join(values_list))
        result_text.config(state=tk.DISABLED)

    except Exception as e:
        messagebox.showerror("ì—ëŸ¬ ë°œìƒ", str(e))


def read_google_sheet(sheet_url, credentials_path, worksheet_name):
    gc = gspread.service_account(filename=credentials_path)
    sh = gc.open_by_url(sheet_url)
    worksheet = sh.worksheet(worksheet_name)
    all_values = worksheet.get_all_values()
    # ì²« í–‰ì—ì„œ ì›í•˜ëŠ” ì»¬ëŸ¼ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
    header = all_values[0]
    idx_account = header.index('ê³„ì •ëª…')
    idx_service = header.index('ì„œë¹„ìŠ¤ì½”ë“œ')
    idx_len = header.index('ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´')
    idx_struct = header.index('ê³ ê°ë²ˆí˜¸êµ¬ì¡°')
    # ì›í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì¶”ì¶œ
    data = [
        [row[idx_account], row[idx_service], row[idx_len], row[idx_struct]]
        for row in all_values[1:]
        if row[idx_account] and row[idx_service]
    ]
    df = pd.DataFrame(data, columns=['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ', 'ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´', 'ê³ ê°ë²ˆí˜¸êµ¬ì¡°'])
    return df

# ì‚¬ìš© ì˜ˆì‹œ
sheet_url = "https://docs.google.com/spreadsheets/d/10XO7o99fYr4e_I_etJF3_eCFa2_dsDs2egSWeu1GAls/edit#gid=679649875"
credentials_path = r"C:\ì œí’ˆë“±ë¡\gcp9304-4410543fedf2.json"
worksheet_name = "INí˜•ì‹"

df = read_google_sheet(sheet_url, credentials_path, worksheet_name)

# "ê³„ì •ëª…"ê³¼ "ì„œë¹„ìŠ¤ì½”ë“œ" ì»¬ëŸ¼ë§Œ ì¶œë ¥ (ë””ë²„ê·¸ìš©)
# print(df[['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ']])

# =====================
# ğŸ“Œ GUI êµ¬ì„± (Tkinter)
# =====================
window = tk.Tk()
window.title("ì„í¬íŠ¸ì²´ì»¤ (v240607)")
window.geometry("1000x600")

# â–¶ ê³„ì •ëª… ì½¤ë³´ë°•ìŠ¤ í”„ë ˆì„
site_frame = tk.Frame(window)
site_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

site_label = tk.Label(site_frame, text="ê³„ì •ëª… ì„ íƒ:")
site_label.pack(side=tk.LEFT)

exclude_accounts = ['ë‚˜ë¼ì¥í„°', 'ë†ì´Œê³µì‚¬', 'ë¡œìš°ë¦¬ìŠ¤', '']
filtered_df = df[~df['ê³„ì •ëª…'].isin(exclude_accounts)].copy()
filtered_df = filtered_df.sort_values('ê³„ì •ëª…').reset_index(drop=True)
site_combobox = ttk.Combobox(site_frame, values=list(filtered_df['ê³„ì •ëª…']), state="readonly")
site_combobox.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))

# ê¸°ë³¸ê°’ "ê²½ë¶í¬í•­" ì„¤ì •
try:
    default_idx = filtered_df[filtered_df['ê³„ì •ëª…'] == 'ê²½ë¶í¬í•­'].index[0]
    site_combobox.current(default_idx)
except (IndexError, KeyError):
    pass  # ê²½ë¶í¬í•­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • ì•ˆ í•¨

# ê³„ì •ëª… ì„ íƒ ì‹œ 4ê°œ ì»¬ëŸ¼ ì •ë³´ íŒì—…
def on_site_select(event):
    idx = site_combobox.current()
    if idx >= 0:
        account_name = filtered_df.iloc[idx]['ê³„ì •ëª…']
        service_code = filtered_df.iloc[idx]['ì„œë¹„ìŠ¤ì½”ë“œ']
        num_len = filtered_df.iloc[idx]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´']
        struct = filtered_df.iloc[idx]['ê³ ê°ë²ˆí˜¸êµ¬ì¡°']
        messagebox.showinfo(
            "ì„ íƒí•œ ê³„ì •",
            f"ê³„ì •ëª…: {account_name}\nì„œë¹„ìŠ¤ì½”ë“œ: {service_code}\nìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´: {num_len}\nê³ ê°ë²ˆí˜¸êµ¬ì¡°: {struct}"
        )
site_combobox.bind('<<ComboboxSelected>>', on_site_select)

# â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ì…ë ¥ í”„ë ˆì„
company_frame = tk.Frame(window)
company_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

company_label = tk.Label(company_frame, text="ì†Œì†/ë‹¨ë§íšŒì‚¬ (ì‹­ì§„ìˆ˜):")
company_label.pack(side=tk.LEFT)

company_entry = tk.Entry(company_frame, width=20)
company_entry.pack(side=tk.LEFT, padx=(5, 0))
company_entry.insert(0, "6")  # ê¸°ë³¸ê°’ 6

# â–¶ DB ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í”„ë ˆì„
db_password_frame = tk.Frame(window)
db_password_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

db_password_label = tk.Label(db_password_frame, text="DB ë¹„ë°€ë²ˆí˜¸:")
db_password_label.pack(side=tk.LEFT)

db_password_entry = tk.Entry(db_password_frame, width=20, show='*')
db_password_entry.pack(side=tk.LEFT, padx=(5, 0))
db_password_entry.insert(0, "mars@icbm")  # ê¸°ë³¸ê°’ ì„¤ì •

# â–¶ ë§¤í•‘ ì¡°íšŒ ì…ë ¥ í”„ë ˆì„
mapping_frame = tk.Frame(window)
mapping_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

mapping_label = tk.Label(mapping_frame, text="ë§¤í•‘ ì¡°íšŒ (ì—¬ëŸ¬ ê°œ ì…ë ¥ ê°€ëŠ¥ - ì¤„ë°”ê¿ˆ/ì‰¼í‘œ êµ¬ë¶„):")
mapping_label.pack(anchor=tk.W)

mapping_input_frame = tk.Frame(mapping_frame)
mapping_input_frame.pack(fill=tk.BOTH, expand=True)

mapping_search_text = tk.Text(mapping_input_frame, height=5, width=60)
mapping_search_text.pack(side=tk.LEFT, padx=(0, 5))

mapping_scrollbar = tk.Scrollbar(mapping_input_frame, command=mapping_search_text.yview)
mapping_scrollbar.pack(side=tk.LEFT, fill=tk.Y)
mapping_search_text.config(yscrollcommand=mapping_scrollbar.set)

# ë§¤í•‘ ê´€ë¦¬ ë²„íŠ¼ í”„ë ˆì„
mapping_buttons_frame = tk.Frame(mapping_frame)
mapping_buttons_frame.pack(pady=(5, 0))

mapping_search_btn = tk.Button(mapping_buttons_frame, text="ì¡°íšŒ", command=search_mapping, bg='#2196F3', fg='white', padx=15, pady=5)
mapping_search_btn.pack(side=tk.LEFT, padx=(0, 5))

mapping_unlink_btn = tk.Button(mapping_buttons_frame, text="ë§¤í•‘í•´ì œ", command=unlink_mapping, bg='#F44336', fg='white', padx=15, pady=5)
mapping_unlink_btn.pack(side=tk.LEFT, padx=5)

mapping_restore_btn = tk.Button(mapping_buttons_frame, text="ë§¤í•‘ì›ë³µ", command=restore_mapping, bg='#FF9800', fg='white', padx=15, pady=5)
mapping_restore_btn.pack(side=tk.LEFT, padx=5)

# â–¶ ë²„íŠ¼ êµ¬ì„±
button_frame = tk.Frame(window)
button_frame.pack(pady=10)

db_test_btn = tk.Button(button_frame, text="DB ì—°ê²° í…ŒìŠ¤íŠ¸", command=test_db_connection, bg='#4CAF50', fg='white', padx=10)
db_test_btn.pack(side=tk.LEFT, padx=5)

excel_btn = tk.Button(button_frame, text="ì—‘ì…€ íŒŒì¼ ì„ íƒ ë° SQL ë³€í™˜", command=generate_sql_from_excel, padx=10)
excel_btn.pack(side=tk.LEFT, padx=5)

# â–¶ ê²°ê³¼ ì¶œë ¥ í”„ë ˆì„
frame = tk.Frame(window)
frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

# â–¶ ê°€ë¡œ ìŠ¤í¬ë¡¤ë°”
x_scrollbar = tk.Scrollbar(frame, orient=tk.HORIZONTAL)
x_scrollbar.pack(side=tk.BOTTOM, fill=tk.X)

# â–¶ ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°”
y_scrollbar = tk.Scrollbar(frame)
y_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

# â–¶ ê²°ê³¼ ì¶œë ¥ í…ìŠ¤íŠ¸ì°½ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
result_text = tk.Text(frame, wrap=tk.NONE, xscrollcommand=x_scrollbar.set, yscrollcommand=y_scrollbar.set)
result_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

x_scrollbar.config(command=result_text.xview)
y_scrollbar.config(command=result_text.yview)

# â–¶ í”„ë¡œê·¸ë¨ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ DB ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (500ms í›„)
window.after(500, test_db_connection)

# â–¶ ë©”ì¸ ë£¨í”„ ì‹¤í–‰
window.mainloop()

