# =============================================
# ğŸ“Œ ì„í¬íŠ¸ì²´ì»¤ (v250723)
# ì‘ì„±ì: ì„œê¸°ëŒ€
# ëª©ì : ìˆ˜ìš©ê°€ ë‹¨ë§ê¸° ë“±ë¡ìš© ì—‘ì…€ íŒŒì¼ì„ SQL VALUES êµ¬ë¬¸ìœ¼ë¡œ ìë™ ë³€í™˜
# ì£¼ìš” ê¸°ëŠ¥:
#   - ì—‘ì…€ íŒŒì¼ ì„ íƒ ì°½ ì œê³µ
#   - ì •í•´ì§„ 20ê°œ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° íŒŒì‹±
#   - ì„±ê³µ/ì‹¤íŒ¨ í•­ëª© ìˆ˜ ì§‘ê³„
#   - ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë° SQL VALUES êµ¬ë¬¸ ì¶œë ¥
#   - ê¸´ í…ìŠ¤íŠ¸ë¥¼ ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì¶œë ¥
#   - ìœ íš¨ì„± ê²€ì‚¬ CASE ë„˜ë²„ë§ ì§€ì›
#   - í”„ë¡œê·¸ë¨ ë²„ì „: v250723
# =============================================

import gspread
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime
from tkinter import ttk
import psycopg2
from psycopg2 import Error
import re
import os
import sys

# ğŸ“Œ ê³„ì •ëª…ë³„ DB ì„¤ì • (ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ìˆëŠ” ê³„ì •ë§Œ ì„¤ì •)
ACCOUNT_DB_CONFIGS = {
    'ê²½ë¶í¬í•­': {
        'host': '10.241.240.219',
        'port': 5433,
        'database': 'mars_icbm',
        'user': 'mars_icbm',
        'password': 'mars@icbm'
    },
    'ì¶©ë‚¨íƒœì•ˆ': {
        'host': '211.53.249.251',
        'port': 5438,
        'database': 'mars_icbm',
        'user': 'mars_icbm',
        'password': 'mars@icbm'
    }
}

# ğŸ“Œ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
def get_db_config(account_name=None):
    """ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ë°˜í™˜ (ì„¤ì •ì´ ì—†ìœ¼ë©´ None)"""
    if account_name and account_name in ACCOUNT_DB_CONFIGS:
        return ACCOUNT_DB_CONFIGS[account_name].copy()
    else:
        return None  # ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì—†ëŠ” ê³„ì •

# ğŸ“Œ ì—‘ì…€ ì»¬ëŸ¼ëª… ì •ì˜ (20ê°œ í•­ëª©)
COLUMNS = [
    'ìˆ˜ìš©ê°€ëª…', 'ìˆ˜ìš©ê°€ë²ˆí˜¸', 'êµ¬ì£¼ì†Œ', 'ì‹ ì£¼ì†Œ', 'ê²½ë„', 'ìœ„ë„', 'ì—…ì¢…', 'ì†Œì†',
    'ë¸”ë¡', 'ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸', 'ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„', 'ê²€ì¹¨ì›', 'ê²€ì¹¨ì¼', 'ê³„ëŸ‰ê¸°ë²ˆí˜¸',
    'êµ¬ê²½', 'í†µì‹ ', 'ë‹¨ë§ ë¶€ë²ˆí˜¸', 'ë‹¨ë§ ì£¼ë²ˆí˜¸', 'ë‹¨ë§ íšŒì‚¬', 'ë‹¨ë§ ì„¤ì¹˜ì¼'
]

# ğŸ“Œ DB ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ê°„ë‹¨í•œ ì¿¼ë¦¬ ì‹¤í–‰
def test_db_connection():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì„ íƒëœ ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        selected_name = site_entry.get().strip()
        db_config = get_db_config(selected_name)
        
        if db_config is None:
            messagebox.showerror(
                "ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ", 
                f"'{selected_name}' ê³„ì •ì€ DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì„¤ì •ëœ ê³„ì •:\n" + 
                "\n".join([f"â˜… {name}" for name in ACCOUNT_DB_CONFIGS.keys()])
            )
            return
        
        # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì • ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        if db_password:
            db_config['password'] = db_password
        elif not db_config.get('password'):
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì¿¼ë¦¬
        cursor.execute("SELECT version();")
        db_version = cursor.fetchone()
        
        # í…Œì´ë¸” ëª©ë¡ ì¡°íšŒ
        cursor.execute("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            ORDER BY table_name 
            LIMIT 10;
        """)
        tables = cursor.fetchall()
        
        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹)
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"âœ… DB ì—°ê²° í…ŒìŠ¤íŠ¸ - {current_time}\n")
        result_text.insert(tk.END, f"Host: {db_config['host']}:{db_config['port']}\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ PostgreSQL ë²„ì „:\n{db_version[0]}\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ í…Œì´ë¸” ëª©ë¡ (ìµœëŒ€ 10ê°œ):\n")
        for idx, table in enumerate(tables, 1):
            result_text.insert(tk.END, f"{idx}. {table[0]}\n")
        result_text.insert(tk.END, "\n")
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("DB ì—°ê²° ì„±ê³µ", "ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤!")
        
    except Error as e:
        messagebox.showerror("DB ì—°ê²° ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘ ì¡°íšŒ í•¨ìˆ˜ (ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ ìë™ ê°ì§€, ë‹¤ì¤‘ ì…ë ¥ ì§€ì›)
def search_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸° (Text ìœ„ì ¯ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹± (ì¤„ë°”ê¿ˆ, ì‰¼í‘œ, ê³µë°±ìœ¼ë¡œ êµ¬ë¶„)
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì„ íƒëœ ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        selected_name = site_entry.get().strip()
        db_config = get_db_config(selected_name)
        
        if db_config is None:
            messagebox.showerror(
                "ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ", 
                f"'{selected_name}' ê³„ì •ì€ DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì„¤ì •ëœ ê³„ì •:\n" + 
                "\n".join([f"â˜… {name}" for name in ACCOUNT_DB_CONFIGS.keys()])
            )
            return
        
        # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì • ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        if db_password:
            db_config['password'] = db_password
        elif not db_config.get('password'):
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ì£¼ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        # ê²°ê³¼ë¥¼ ë”•ì…”ë„ˆë¦¬ë¡œ ì €ì¥ (ê²€ìƒ‰ í‚¤ë³„ë¡œ)
        results_dict = {}
        
        # ë‹¨ë§ì£¼ë²ˆí˜¸ë¡œ ì¡°íšŒ
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            query = f"""
                SELECT c.admin_no, d.dev_no, d.sub_dev_no, d.point_sq, p.cust_sq
                FROM public.tb_m1_cmap_device d
                LEFT JOIN public.tb_m1_info_point p ON d.point_sq = p.point_sq
                LEFT JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                WHERE d.dev_no IN ({placeholders});
            """
            cursor.execute(query, device_nos)
            for row in cursor.fetchall():
                results_dict[row[1]] = row  # dev_noë¥¼ í‚¤ë¡œ ì‚¬ìš©
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ì¡°íšŒ
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            query = f"""
                SELECT c.admin_no, d.dev_no, d.sub_dev_no, d.point_sq, p.cust_sq
                FROM public.tb_m1_cmap_device d
                JOIN public.tb_m1_info_point p ON d.point_sq = p.point_sq
                JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                WHERE c.admin_no IN ({placeholders});
            """
            cursor.execute(query, admin_nos)
            for row in cursor.fetchall():
                results_dict[row[0]] = row  # admin_noë¥¼ í‚¤ë¡œ ì‚¬ìš©
        
        # ì…ë ¥ ìˆœì„œëŒ€ë¡œ ê²°ê³¼ ì •ë ¬
        all_results = []
        for search_val in search_values:
            if search_val in results_dict:
                all_results.append(results_dict[search_val])
        
        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹ - ëˆ„ì )
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        # delete ì œê±° - ë¡œê·¸ ëˆ„ì 
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"ğŸ” ë§¤í•‘ ì¡°íšŒ ê²°ê³¼ - {current_time}\n")
        result_text.insert(tk.END, f"ê²€ìƒ‰ í•­ëª©: {len(search_values)}ê°œ (ë‹¨ë§ì£¼ë²ˆí˜¸: {len(device_nos)}ê°œ, ìˆ˜ìš©ê°€ë²ˆí˜¸: {len(admin_nos)}ê°œ)\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")
        
        if all_results:
            result_text.insert(tk.END, f"âœ… {len(all_results)}ê°œì˜ ë§¤í•‘ ë°œê²¬\n\n")
            result_text.insert(tk.END, f"{'ìˆ˜ìš©ê°€ë²ˆí˜¸':<20} {'ë‹¨ë§ë¶€ë²ˆí˜¸':<30} {'ë‹¨ë§ì£¼ë²ˆí˜¸':<15} {'point_sq':<10} {'cust_sq':<10}\n")
            result_text.insert(tk.END, "-"*120 + "\n")
            for admin_no, dev_no, sub_dev_no, point_sq, cust_sq in all_results:
                # NULL ê°’ ì²˜ë¦¬
                admin_no_str = admin_no if admin_no else 'NULL'
                sub_dev_no_str = sub_dev_no if sub_dev_no else 'NULL'
                point_sq_str = str(point_sq) if point_sq else 'NULL'
                cust_sq_str = str(cust_sq) if cust_sq else 'NULL'
                result_text.insert(tk.END, f"{admin_no_str:<20} {sub_dev_no_str:<30} {dev_no:<15} {point_sq_str:<10} {cust_sq_str:<10}\n")
        else:
            result_text.insert(tk.END, "âŒ ë§¤í•‘ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n")
        
        result_text.insert(tk.END, "\n")
        # ìë™ ìŠ¤í¬ë¡¤ (ìµœì‹  ë¡œê·¸ë¡œ)
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
    except Error as e:
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘í•´ì œ í•¨ìˆ˜ (ë‹¨ë§ì£¼ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ ì—°ê²° í•´ì œ)
def unlink_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹±
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # í™•ì¸ ë©”ì‹œì§€
        if not messagebox.askyesno("ë§¤í•‘í•´ì œ í™•ì¸", f"{len(search_values)}ê°œì˜ ë§¤í•‘ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\npoint_sqë¥¼ NULLë¡œ ì„¤ì •í•©ë‹ˆë‹¤."):
            return
        
        # ì„ íƒëœ ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        selected_name = site_entry.get().strip()
        db_config = get_db_config(selected_name)
        
        if db_config is None:
            messagebox.showerror(
                "ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ", 
                f"'{selected_name}' ê³„ì •ì€ DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì„¤ì •ëœ ê³„ì •:\n" + 
                "\n".join([f"â˜… {name}" for name in ACCOUNT_DB_CONFIGS.keys()])
            )
            return
        
        # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì • ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        if db_password:
            db_config['password'] = db_password
        elif not db_config.get('password'):
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ì£¼ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        unlinked_count = 0
        
        # íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device DISABLE TRIGGER ALL;")
        
        # ë‹¨ë§ì£¼ë²ˆí˜¸ë¡œ ë§¤í•‘í•´ì œ (point_sqë¥¼ NULLë¡œ ì„¤ì •)
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            
            # 1. í•´ì œ ì „ ìƒíƒœë¥¼ ë°±ì—… ì´ë ¥ì— ì €ì¥
            backup_query = f"""
                INSERT INTO public.tb_m1_cmap_device_back_his 
                (dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, upd_dt, his_dt, his_cd)
                SELECT dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, 
                       CURRENT_TIMESTAMP, TO_CHAR(CURRENT_DATE, 'YYYYMMDD'), 'UNLINK'
                FROM public.tb_m1_cmap_device
                WHERE dev_no IN ({placeholders})
                AND point_sq IS NOT NULL;
            """
            cursor.execute(backup_query, device_nos)
            
            # 2. ë§¤í•‘ í•´ì œ
            query = f"""
                UPDATE public.tb_m1_cmap_device
                SET point_sq = NULL
                WHERE dev_no IN ({placeholders});
            """
            cursor.execute(query, device_nos)
            unlinked_count += cursor.rowcount
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë§¤í•‘í•´ì œ (í•´ë‹¹ ìˆ˜ìš©ê°€ì˜ ëª¨ë“  ë‹¨ë§ ë§¤í•‘ í•´ì œ)
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            
            # 1. í•´ì œ ì „ ìƒíƒœë¥¼ ë°±ì—… ì´ë ¥ì— ì €ì¥
            backup_query = f"""
                WITH point_to_delete AS (
                    SELECT p.point_sq
                    FROM public.tb_m1_info_point p
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no IN ({placeholders})
                )
                INSERT INTO public.tb_m1_cmap_device_back_his 
                (dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, upd_dt, his_dt, his_cd)
                SELECT dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, 
                       CURRENT_TIMESTAMP, TO_CHAR(CURRENT_DATE, 'YYYYMMDD'), 'UNLINK'
                FROM public.tb_m1_cmap_device
                WHERE point_sq IN (SELECT point_sq FROM point_to_delete)
                AND point_sq IS NOT NULL;
            """
            cursor.execute(backup_query, admin_nos)
            
            # 2. ë§¤í•‘ í•´ì œ
            query = f"""
                WITH point_to_delete AS (
                    SELECT p.point_sq
                    FROM public.tb_m1_info_point p
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no IN ({placeholders})
                )
                UPDATE public.tb_m1_cmap_device
                SET point_sq = NULL
                WHERE point_sq IN (SELECT point_sq FROM point_to_delete);
            """
            cursor.execute(query, admin_nos)
            unlinked_count += cursor.rowcount
        
        # íŠ¸ë¦¬ê±° í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        connection.commit()
        
        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹)
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"ğŸ—‘ï¸ ë§¤í•‘í•´ì œ ì™„ë£Œ - {current_time}\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")
        result_text.insert(tk.END, f"âœ… {unlinked_count}ê°œì˜ ë§¤í•‘ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n")
        result_text.insert(tk.END, f"ğŸ“Œ ì²˜ë¦¬ëœ í•­ëª©: ë‹¨ë§ì£¼ë²ˆí˜¸ {len(device_nos)}ê°œ, ìˆ˜ìš©ê°€ë²ˆí˜¸ {len(admin_nos)}ê°œ\n")
        result_text.insert(tk.END, f"ğŸ’¡ point_sq â†’ NULL, ë°±ì—… ì´ë ¥ ì €ì¥ (his_cd='UNLINK')\n\n")
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("ë§¤í•‘í•´ì œ ì™„ë£Œ", f"{unlinked_count}ê°œì˜ ë§¤í•‘ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Error as e:
        # ì—ëŸ¬ ë°œìƒ ì‹œ íŠ¸ë¦¬ê±° ì¬í™œì„±í™” ì‹œë„
        try:
            cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
            connection.commit()
        except:
            pass
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘ ìƒì„± í•¨ìˆ˜ (ìˆ˜ìš©ê°€ë²ˆí˜¸-ë‹¨ë§ì£¼ë²ˆí˜¸ 1:1 ë§¤í•‘)
def create_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ìˆ˜ìš©ê°€ë²ˆí˜¸-ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.\nì˜ˆ: 2-001302290000,01236564855")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹± (ìˆ˜ìš©ê°€ë²ˆí˜¸-ë‹¨ë§ì£¼ë²ˆí˜¸ ë˜ëŠ” ìˆ˜ìš©ê°€ë²ˆí˜¸,ë‹¨ë§ì£¼ë²ˆí˜¸ í˜•ì‹)
        lines = search_text.split('\n')
        mapping_pairs = []
        
        for line in lines:
            line = line.strip()
            if not line:
                continue
            
            # '-' ë˜ëŠ” ',' ë˜ëŠ” ê³µë°±ìœ¼ë¡œ êµ¬ë¶„
            if ',' in line:
                parts = line.split(',')
            elif '-' in line and line.count('-') >= 2:  # ìˆ˜ìš©ê°€ë²ˆí˜¸ì— ì´ë¯¸ '-'ê°€ ìˆìœ¼ë¯€ë¡œ 2ê°œ ì´ìƒì¼ ë•Œ
                # ë§ˆì§€ë§‰ '-'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¶„ë¦¬
                idx = line.rfind('-')
                if idx > 0 and line[idx+1:].startswith('012'):  # ë‹¨ë§ì£¼ë²ˆí˜¸ëŠ” 012ë¡œ ì‹œì‘
                    parts = [line[:idx], line[idx+1:]]
                else:
                    parts = line.split()
            else:
                parts = line.split()
            
            if len(parts) >= 2:
                admin_no = parts[0].strip()
                dev_no = parts[1].strip()
                
                # ë‹¨ë§ì£¼ë²ˆí˜¸ ê²€ì¦ (012ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬)
                if dev_no.startswith('012') and len(dev_no) == 11:
                    mapping_pairs.append((admin_no, dev_no))
                else:
                    messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", f"ì˜ëª»ëœ ë‹¨ë§ì£¼ë²ˆí˜¸: {dev_no}\në‹¨ë§ì£¼ë²ˆí˜¸ëŠ” 012ë¡œ ì‹œì‘í•˜ëŠ” 11ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.")
                    return
        
        if not mapping_pairs:
            messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ìœ íš¨í•œ ë§¤í•‘ ìŒì„ ì…ë ¥í•˜ì„¸ìš”.\ní˜•ì‹: ìˆ˜ìš©ê°€ë²ˆí˜¸,ë‹¨ë§ì£¼ë²ˆí˜¸ ë˜ëŠ” ìˆ˜ìš©ê°€ë²ˆí˜¸ ë‹¨ë§ì£¼ë²ˆí˜¸")
            return
        
        # í™•ì¸ ë©”ì‹œì§€
        if not messagebox.askyesno("ë§¤í•‘ ìƒì„± í™•ì¸", f"{len(mapping_pairs)}ê°œì˜ ë§¤í•‘ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"):
            return
        
        # ì„ íƒëœ ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        selected_name = site_entry.get().strip()
        db_config = get_db_config(selected_name)
        
        if db_config is None:
            messagebox.showerror(
                "ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ", 
                f"'{selected_name}' ê³„ì •ì€ DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì„¤ì •ëœ ê³„ì •:\n" + 
                "\n".join([f"â˜… {name}" for name in ACCOUNT_DB_CONFIGS.keys()])
            )
            return
        
        # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì • ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        if db_password:
            db_config['password'] = db_password
        elif not db_config.get('password'):
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device DISABLE TRIGGER ALL;")
        
        # 1. ëª¨ë“  ë‹¨ë§ì£¼ë²ˆí˜¸ê°€ ë§¤í•‘í•´ì œ ìƒíƒœì¸ì§€ í™•ì¸
        dev_nos = [dev_no for _, dev_no in mapping_pairs]
        placeholders = ','.join(['%s'] * len(dev_nos))
        check_query = f"""
            SELECT dev_no, point_sq 
            FROM public.tb_m1_cmap_device 
            WHERE dev_no IN ({placeholders})
            AND point_sq IS NOT NULL;
        """
        cursor.execute(check_query, dev_nos)
        already_mapped = cursor.fetchall()
        
        if already_mapped:
            # íŠ¸ë¦¬ê±° í™œì„±í™”
            cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
            cursor.close()
            connection.close()
            
            # ì´ë¯¸ ë§¤í•‘ëœ ë‹¨ë§ ëª©ë¡ í‘œì‹œ
            mapped_list = "\n".join([f"  - {dev_no} (point_sq: {point_sq})" for dev_no, point_sq in already_mapped])
            messagebox.showerror(
                "ë§¤í•‘ ì˜¤ë¥˜", 
                f"ë‹¤ìŒ ë‹¨ë§ì£¼ë²ˆí˜¸ëŠ” ì´ë¯¸ ë§¤í•‘ë˜ì–´ ìˆìŠµë‹ˆë‹¤:\n\n{mapped_list}\n\në¨¼ì € ë§¤í•‘í•´ì œë¥¼ ì§„í–‰í•˜ì„¸ìš”."
            )
            return
        
        # 2. ë§¤í•‘ ìƒì„±
        created_count = 0
        for admin_no, dev_no in mapping_pairs:
            query = """
                WITH point_to_update AS (
                    SELECT c.admin_no, p.point_sq
                    FROM public.tb_m1_info_point p
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no = %s
                )
                UPDATE public.tb_m1_cmap_device AS dev
                SET point_sq = ptu.point_sq
                FROM point_to_update AS ptu
                WHERE dev.dev_no = %s AND ptu.admin_no = %s;
            """
            cursor.execute(query, (admin_no, dev_no, admin_no))
            created_count += cursor.rowcount
        
        # 3. ìƒì„± í›„ ìƒíƒœë¥¼ ë°±ì—… ì´ë ¥ì— ì €ì¥
        if dev_nos:
            placeholders = ','.join(['%s'] * len(dev_nos))
            backup_query = f"""
                INSERT INTO public.tb_m1_cmap_device_back_his 
                (dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, upd_dt, his_dt, his_cd)
                SELECT dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, 
                       CURRENT_TIMESTAMP, TO_CHAR(CURRENT_DATE, 'YYYYMMDD'), 'CREATE'
                FROM public.tb_m1_cmap_device
                WHERE dev_no IN ({placeholders})
                AND point_sq IS NOT NULL;
            """
            cursor.execute(backup_query, dev_nos)
        
        # íŠ¸ë¦¬ê±° í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        connection.commit()
        
        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹)
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"âœ¨ ë§¤í•‘ ìƒì„± ì™„ë£Œ - {current_time}\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")
        result_text.insert(tk.END, f"âœ… {created_count}ê°œì˜ ë§¤í•‘ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n")
        result_text.insert(tk.END, f"ğŸ“Œ ìƒì„±ëœ ë§¤í•‘:\n")
        for admin_no, dev_no in mapping_pairs:
            result_text.insert(tk.END, f"   {admin_no} â† {dev_no}\n")
        result_text.insert(tk.END, f"\nğŸ’¾ ë°±ì—… ì´ë ¥ ì €ì¥ (his_cd='CREATE')\n\n")
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("ë§¤í•‘ ìƒì„± ì™„ë£Œ", f"{created_count}ê°œì˜ ë§¤í•‘ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Error as e:
        # ì—ëŸ¬ ë°œìƒ ì‹œ íŠ¸ë¦¬ê±° ì¬í™œì„±í™” ì‹œë„
        try:
            cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
            connection.commit()
        except:
            pass
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ë§¤í•‘ì›ë³µ í•¨ìˆ˜ (ë°±ì—…ì—ì„œ ì›ìƒíƒœë¡œ ë³µì›)
def restore_mapping():
    try:
        # ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
        db_password = db_password_entry.get()
        if not db_password:
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
        search_text = mapping_search_text.get("1.0", tk.END).strip()
        if not search_text:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # ì…ë ¥ê°’ íŒŒì‹±
        search_values = re.split(r'[\n,\s]+', search_text)
        search_values = [v.strip() for v in search_values if v.strip()]
        
        if not search_values:
            messagebox.showwarning("ê²€ìƒ‰ì–´ ì…ë ¥", "ìœ íš¨í•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # í™•ì¸ ë©”ì‹œì§€
        if not messagebox.askyesno("ë§¤í•‘ì›ë³µ í™•ì¸", f"{len(search_values)}ê°œì˜ ë§¤í•‘ì„ ë°±ì—…ì—ì„œ ì›ë³µí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\në°±ì—… í…Œì´ë¸”(tb_m1_cmap_device_back_his)ì—ì„œ ë³µì›í•©ë‹ˆë‹¤."):
            return
        
        # ì„ íƒëœ ê³„ì •ëª…ì— ë”°ë¥¸ DB ì„¤ì • ê°€ì ¸ì˜¤ê¸°
        selected_name = site_entry.get().strip()
        db_config = get_db_config(selected_name)
        
        if db_config is None:
            messagebox.showerror(
                "ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ", 
                f"'{selected_name}' ê³„ì •ì€ DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.\n\nì„¤ì •ëœ ê³„ì •:\n" + 
                "\n".join([f"â˜… {name}" for name in ACCOUNT_DB_CONFIGS.keys()])
            )
            return
        
        # ë¹„ë°€ë²ˆí˜¸ ì„¤ì • (ì…ë ¥ëœ ë¹„ë°€ë²ˆí˜¸ ìš°ì„ , ì—†ìœ¼ë©´ ê³„ì • ì„¤ì • ë¹„ë°€ë²ˆí˜¸ ì‚¬ìš©)
        if db_password:
            db_config['password'] = db_password
        elif not db_config.get('password'):
            messagebox.showwarning("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥", "DB ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.")
            return
        
        # DB ì—°ê²°
        connection = psycopg2.connect(**db_config)
        cursor = connection.cursor()
        
        # ì…ë ¥ê°’ì„ ë‹¨ë§ì£¼ë²ˆí˜¸ì™€ ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë¶„ë¥˜
        device_nos = []
        admin_nos = []
        
        for value in search_values:
            if value.startswith('012') and len(value) == 11:
                device_nos.append(value)
            else:
                admin_nos.append(value)
        
        restored_count = 0
        
        # íŠ¸ë¦¬ê±° ë¹„í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device DISABLE TRIGGER ALL;")
        
        # ë‹¨ë§ì£¼ë²ˆí˜¸ë¡œ ë°±ì—…ì—ì„œ ë³µì› (ê°€ì¥ ìµœê·¼ ì´ë ¥ ì‚¬ìš©)
        if device_nos:
            placeholders = ','.join(['%s'] * len(device_nos))
            
            # 1. ë³µì› ì‹¤í–‰
            query = f"""
                WITH latest_backup AS (
                    SELECT DISTINCT ON (dev_no) dev_no, point_sq
                    FROM public.tb_m1_cmap_device_back_his
                    WHERE dev_no IN ({placeholders})
                    AND point_sq IS NOT NULL
                    ORDER BY dev_no, his_dt DESC, upd_dt DESC
                )
                UPDATE public.tb_m1_cmap_device AS dev
                SET point_sq = lb.point_sq
                FROM latest_backup AS lb
                WHERE dev.dev_no = lb.dev_no;
            """
            cursor.execute(query, device_nos)
            restored_count += cursor.rowcount
            
            # 2. ë³µì› í›„ ìƒíƒœë¥¼ ë°±ì—… ì´ë ¥ì— ì €ì¥
            backup_query = f"""
                INSERT INTO public.tb_m1_cmap_device_back_his 
                (dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, upd_dt, his_dt, his_cd)
                SELECT dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, 
                       CURRENT_TIMESTAMP, TO_CHAR(CURRENT_DATE, 'YYYYMMDD'), 'RESTORE'
                FROM public.tb_m1_cmap_device
                WHERE dev_no IN ({placeholders})
                AND point_sq IS NOT NULL;
            """
            cursor.execute(backup_query, device_nos)
        
        # ìˆ˜ìš©ê°€ë²ˆí˜¸ë¡œ ë°±ì—…ì—ì„œ ë³µì› (ê°€ì¥ ìµœê·¼ ì´ë ¥ ì‚¬ìš©)
        if admin_nos:
            placeholders = ','.join(['%s'] * len(admin_nos))
            
            # 1. ë³µì› ì‹¤í–‰
            query = f"""
                WITH latest_backup AS (
                    SELECT DISTINCT ON (bak.dev_no) bak.dev_no, bak.point_sq
                    FROM public.tb_m1_cmap_device_back_his bak
                    JOIN public.tb_m1_info_point p ON bak.point_sq = p.point_sq
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no IN ({placeholders})
                    AND bak.point_sq IS NOT NULL
                    ORDER BY bak.dev_no, bak.his_dt DESC, bak.upd_dt DESC
                )
                UPDATE public.tb_m1_cmap_device AS dev
                SET point_sq = lb.point_sq
                FROM latest_backup AS lb
                WHERE dev.dev_no = lb.dev_no;
            """
            cursor.execute(query, admin_nos)
            restored_count += cursor.rowcount
            
            # 2. ë³µì› í›„ ìƒíƒœë¥¼ ë°±ì—… ì´ë ¥ì— ì €ì¥
            backup_query = f"""
                WITH latest_backup AS (
                    SELECT DISTINCT ON (bak.dev_no) bak.dev_no
                    FROM public.tb_m1_cmap_device_back_his bak
                    JOIN public.tb_m1_info_point p ON bak.point_sq = p.point_sq
                    JOIN public.tb_m1_info_customer c ON p.cust_sq = c.cust_sq
                    WHERE c.admin_no IN ({placeholders})
                    AND bak.point_sq IS NOT NULL
                    ORDER BY bak.dev_no, bak.his_dt DESC, bak.upd_dt DESC
                )
                INSERT INTO public.tb_m1_cmap_device_back_his 
                (dev_no, sub_dev_no, point_sq, company_sq, ami_type, ins_dt, upd_dt, his_dt, his_cd)
                SELECT dev.dev_no, dev.sub_dev_no, dev.point_sq, dev.company_sq, dev.ami_type, dev.ins_dt, 
                       CURRENT_TIMESTAMP, TO_CHAR(CURRENT_DATE, 'YYYYMMDD'), 'RESTORE'
                FROM public.tb_m1_cmap_device dev
                WHERE dev.dev_no IN (SELECT dev_no FROM latest_backup)
                AND dev.point_sq IS NOT NULL;
            """
            cursor.execute(backup_query, admin_nos)
        
        # íŠ¸ë¦¬ê±° í™œì„±í™”
        cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
        
        # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        connection.commit()
        
        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹)
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"ğŸ”„ ë§¤í•‘ì›ë³µ ì™„ë£Œ - {current_time}\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")
        result_text.insert(tk.END, f"âœ… {restored_count}ê°œì˜ ë§¤í•‘ì´ ì›ë³µë˜ì—ˆìŠµë‹ˆë‹¤.\n")
        result_text.insert(tk.END, f"ğŸ“Œ ì²˜ë¦¬ëœ í•­ëª©: ë‹¨ë§ì£¼ë²ˆí˜¸ {len(device_nos)}ê°œ, ìˆ˜ìš©ê°€ë²ˆí˜¸ {len(admin_nos)}ê°œ\n")
        result_text.insert(tk.END, f"ğŸ’¡ ë°±ì—… í…Œì´ë¸”ì—ì„œ point_sq ë³µì›, ë°±ì—… ì´ë ¥ ì €ì¥ (his_cd='RESTORE')\n\n")
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)
        
        cursor.close()
        connection.close()
        
        messagebox.showinfo("ë§¤í•‘ì›ë³µ ì™„ë£Œ", f"{restored_count}ê°œì˜ ë§¤í•‘ì´ ë°±ì—…ì—ì„œ ì›ë³µë˜ì—ˆìŠµë‹ˆë‹¤.")
        
    except Error as e:
        # ì—ëŸ¬ ë°œìƒ ì‹œ íŠ¸ë¦¬ê±° ì¬í™œì„±í™” ì‹œë„
        try:
            cursor.execute("ALTER TABLE public.tb_m1_cmap_device ENABLE TRIGGER ALL;")
            connection.commit()
        except:
            pass
        messagebox.showerror("DB ì¿¼ë¦¬ ì˜¤ë¥˜", f"ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì‹¤íŒ¨:\n{e}")
    except Exception as e:
        messagebox.showerror("ì˜¤ë¥˜ ë°œìƒ", f"ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:\n{e}")

# ğŸ“Œ ì—‘ì…€ íŒŒì¼ì„ ì½ê³  SQL VALUES êµ¬ë¬¸ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
def generate_sql_from_excel():
    # íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    file_path = filedialog.askopenfilename(title="ì—‘ì…€ íŒŒì¼ ì„ íƒ", filetypes=[("Excel files", "*.xlsx *.xls")])
    if not file_path:
        messagebox.showwarning("íŒŒì¼ ì„ íƒ", "íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì…ë ¥ëœ ê³„ì •ëª…ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°€ì ¸ì˜¤ê¸°
    selected_name = site_entry.get().strip()
    if not selected_name:
        messagebox.showwarning("ê³„ì •ëª… ì„ íƒ", "ë¨¼ì € ê³„ì •ëª…ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return
    
    # filtered_dfì—ì„œ ì„ íƒëœ ê³„ì •ëª… ì°¾ê¸°
    matches = filtered_df[filtered_df['ê³„ì •ëª…'] == selected_name]
    if matches.empty:
        messagebox.showwarning("ê³„ì •ëª… ì˜¤ë¥˜", f"'{selected_name}'ì€(ëŠ”) ìœ íš¨í•œ ê³„ì •ëª…ì´ ì•„ë‹™ë‹ˆë‹¤.")
        return
    
    try:
        selected_num_len = int(matches.iloc[0]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´'])
    except Exception:
        messagebox.showerror("ê³„ì •ëª… ì˜¤ë¥˜", "ì„ íƒí•œ ê³„ì •ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ ê°€ì ¸ì˜¤ê¸°
    company_value = company_entry.get().strip()
    if not company_value:
        messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return
    try:
        company_sq = int(company_value)
    except ValueError:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì€ ì •ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
        return

    try:
        # ì—‘ì…€ ë°ì´í„°í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê³µë°± ì±„ì›€
        df = pd.read_excel(file_path, dtype=str).fillna('')
        df = df.iloc[:, 1:1+len(COLUMNS)]  # ì²« ì—´ ì œì™¸ í›„ 20ì—´ë§Œ ì„ íƒ
        df.columns = COLUMNS

        # â–¶ ì¤‘ë³µ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë¯¸ë¦¬ ì§‘ê³„
        admin_no_counts = df['ìˆ˜ìš©ê°€ë²ˆí˜¸'].value_counts()
        duplicated_admin_nos = set(admin_no_counts[admin_no_counts > 1].index)

        values_list = []
        success_count = 0
        fail_count = 0
        success_admin_no_list = []  # ì„±ê³µí•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ì €ì¥

        # ê° í–‰ ë°˜ë³µ ì²˜ë¦¬
        validation_cases = [
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ë²ˆí˜¸']) == selected_num_len, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ë¶ˆì¼ì¹˜"),
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ ê²€ì‚¬", lambda row: row['ìˆ˜ìš©ê°€ë²ˆí˜¸'] not in duplicated_admin_nos, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ"),
            ("ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸']) < 14, "ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ 13ìë¦¬ ì´ˆê³¼"),
            
        ]

        for idx_row, row in df.iterrows():
            try:
                for case_num, (desc, check_func, err_msg) in enumerate(validation_cases, 1):
                    if not check_func(row):
                        raise ValueError(f"[CASE #{case_num}] {err_msg} (ê°’: {row['ìˆ˜ìš©ê°€ë²ˆí˜¸']})")
                # ìˆ«ì ë³€í™˜ì´ í•„ìš”í•œ ì»¬ëŸ¼ì— ëŒ€í•´ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
                def safe_float(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return float(val)
                def safe_int(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return int(float(val))
                values = (
                    row['ìˆ˜ìš©ê°€ëª…'],
                    row['ìˆ˜ìš©ê°€ë²ˆí˜¸'],
                    row['êµ¬ì£¼ì†Œ'],
                    row['ì‹ ì£¼ì†Œ'],
                    safe_float(row['ê²½ë„'], 'ê²½ë„'),
                    safe_float(row['ìœ„ë„'], 'ìœ„ë„'),
                    row['ì—…ì¢…'],
                    company_sq,
                    row['ë¸”ë¡'],
                    row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸'],
                    row['ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„'],
                    row['ê²€ì¹¨ì›'],
                    safe_int(row['ê²€ì¹¨ì¼'], 'ê²€ì¹¨ì¼'),
                    row['ê³„ëŸ‰ê¸°ë²ˆí˜¸'],
                    safe_int(row['êµ¬ê²½'], 'êµ¬ê²½'),
                    row['í†µì‹ '],
                    row['ë‹¨ë§ ë¶€ë²ˆí˜¸'],
                    row['ë‹¨ë§ ì£¼ë²ˆí˜¸'],
                    company_sq,
                    f"{pd.to_datetime(row['ë‹¨ë§ ì„¤ì¹˜ì¼']).date()}"
                )
                # SQL VALUES ë¬¸ìì—´ í¬ë§·íŒ…
                formatted = "('{}', '{}', '{}', '{}', {}, {}, '{}', {}, '{}', '{}', '{}', '{}', {}, '{}', {}, '{}', '{}', '{}', {}, '{}'::timestamp)".format(*values)
                values_list.append(formatted)
                success_admin_no_list.append(row['ìˆ˜ìš©ê°€ë²ˆí˜¸'])
                success_count += 1
            except Exception as e:
                values_list.append(f"-- [ERROR #{idx_row+1}] {e}")
                fail_count += 1

        # ê²°ê³¼ ì¶œë ¥ (ë¡œê·¸ í˜•ì‹)
        from datetime import datetime
        current_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        result_text.config(state=tk.NORMAL)
        result_text.insert(tk.END, f"\n{'='*120}\n")
        result_text.insert(tk.END, f"ğŸ“„ ì—‘ì…€ ë³€í™˜ ì™„ë£Œ - {current_time}\n")
        result_text.insert(tk.END, f"íŒŒì¼: {file_path}\n")
        result_text.insert(tk.END, f"{'='*120}\n\n")

        # âœ… ì„±ê³µ/ì‹¤íŒ¨ í†µê³„ ì¶œë ¥
        result_text.insert(tk.END, f"-- ì´ {len(df)}ê°œ ì¤‘ {success_count}ê°œ ì„±ê³µ, {fail_count}ê°œ ì‹¤íŒ¨\n\n")

        # âœ… ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë¨¼ì € ì¶œë ¥
        result_text.insert(tk.END, "-- âœ… ì„í¬íŠ¸ì „ ì¡°íšŒí•  ìˆ˜ìš©ê°€ëª©ë¡\n")
        result_text.insert(tk.END, ",\n".join(f"'{x}'" for x in success_admin_no_list) + "\n\n")

        # âœ… SQL VALUES ì¶œë ¥
        result_text.insert(tk.END, ",\n".join(values_list))
        result_text.insert(tk.END, "\n\n")
        result_text.see(tk.END)
        result_text.config(state=tk.DISABLED)

    except Exception as e:
        messagebox.showerror("ì—ëŸ¬ ë°œìƒ", str(e))


def read_google_sheet(sheet_url, credentials_path, worksheet_name):
    gc = gspread.service_account(filename=credentials_path)
    sh = gc.open_by_url(sheet_url)
    worksheet = sh.worksheet(worksheet_name)
    
    # ë°ì´í„° ë²”ìœ„ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì§€ì • (A1ë¶€í„° ì¶©ë¶„íˆ í° ë²”ìœ„ê¹Œì§€)
    all_values = worksheet.get('A1:Z1000')  # A1ë¶€í„° Zì—´ 1000í–‰ê¹Œì§€
    
    if not all_values:
        return pd.DataFrame(columns=['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ', 'ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´', 'ê³ ê°ë²ˆí˜¸êµ¬ì¡°'])
    
    # ì²« í–‰ì—ì„œ ì›í•˜ëŠ” ì»¬ëŸ¼ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
    header = all_values[0]
    
    # ë””ë²„ê¹…: í—¤ë” ì „ì²´ ì¶œë ¥
    print(f"\n[DEBUG] í—¤ë” ì „ì²´ ({len(header)}ê°œ ì»¬ëŸ¼):")
    for idx, col in enumerate(header):
        if col:  # ë¹„ì–´ìˆì§€ ì•Šì€ ì»¬ëŸ¼ë§Œ ì¶œë ¥
            print(f"  {idx}: '{col}'")
    
    # ì¤‘ë³µëœ ì»¬ëŸ¼ëª… ì²˜ë¦¬: ì„œë¹„ìŠ¤ì½”ë“œ ì˜†ì— ìˆëŠ” ê³„ì •ëª… ì‚¬ìš©
    # ì„œë¹„ìŠ¤ì½”ë“œë¥¼ ë¨¼ì € ì°¾ê³ , ê·¸ ì•ì˜ ê³„ì •ëª…ì„ ì‚¬ìš©
    idx_service = header.index('ì„œë¹„ìŠ¤ì½”ë“œ')
    idx_len = header.index('ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´')
    idx_struct = header.index('ê³ ê°ë²ˆí˜¸êµ¬ì¡°')
    
    # ì„œë¹„ìŠ¤ì½”ë“œ ë°”ë¡œ ì• ì»¬ëŸ¼ì´ ê³„ì •ëª…ì¸ì§€ í™•ì¸
    if idx_service > 0 and header[idx_service - 1] == 'ê³„ì •ëª…':
        idx_account = idx_service - 1
    else:
        # ëª¨ë“  'ê³„ì •ëª…' ì»¬ëŸ¼ ì°¾ê¸°
        account_indices = [i for i, col in enumerate(header) if col == 'ê³„ì •ëª…']
        print(f"[DEBUG] 'ê³„ì •ëª…' ì»¬ëŸ¼ ë°œê²¬ ìœ„ì¹˜: {account_indices}")
        # ì„œë¹„ìŠ¤ì½”ë“œì— ê°€ì¥ ê°€ê¹Œìš´ ê³„ì •ëª… ì‚¬ìš©
        idx_account = min(account_indices, key=lambda x: abs(x - idx_service))
    
    # ì›í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì¶”ì¶œ (ë¹ˆ í–‰ë„ í¬í•¨í•˜ì—¬ ëª¨ë“  í–‰ ê²€ì‚¬)
    data = []
    skipped = []
    for i, row in enumerate(all_values[1:], start=2):
        # í–‰ì´ ë¹„ì–´ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
        if not row or len(row) == 0:
            continue
        
        # ê° ì»¬ëŸ¼ ê°’ ê°€ì ¸ì˜¤ê¸° (ì•ˆì „í•˜ê²Œ)
        account = row[idx_account] if idx_account < len(row) else ''
        service = row[idx_service] if idx_service < len(row) else ''
        num_len = row[idx_len] if idx_len < len(row) else ''
        struct = row[idx_struct] if idx_struct < len(row) else ''
        
        # 4ê°œ í•„ë“œ ëª¨ë‘ ê°’ì´ ìˆëŠ”ì§€ í™•ì¸
        if account and service and num_len and struct:
            # ê³ ê°ë²ˆí˜¸êµ¬ì¡°ì˜ ê¸¸ì´ê°€ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ ê²€ì¦
            try:
                expected_len = int(num_len)
                actual_len = len(struct)
                
                if actual_len == expected_len:
                    data.append([account, service, num_len, struct])
                else:
                    skipped.append(f"í–‰ {i}: ê³„ì •ëª…='{account}' - ê¸¸ì´ ë¶ˆì¼ì¹˜ (ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´={expected_len}, ê³ ê°ë²ˆí˜¸êµ¬ì¡°ê¸¸ì´={actual_len}, ê³ ê°ë²ˆí˜¸êµ¬ì¡°='{struct}')")
            except ValueError:
                skipped.append(f"í–‰ {i}: ê³„ì •ëª…='{account}' - ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ê°€ ìˆ«ìê°€ ì•„ë‹˜ ('{num_len}')")
        else:
            # í•˜ë‚˜ë¼ë„ ë¹„ì–´ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸° (ë””ë²„ê¹…ìš© ê¸°ë¡)
            if account or service or num_len or struct:  # í•˜ë‚˜ë¼ë„ ê°’ì´ ìˆìœ¼ë©´ ê¸°ë¡
                skipped.append(f"í–‰ {i}: ê³„ì •ëª…='{account}', ì„œë¹„ìŠ¤ì½”ë“œ='{service}', ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´='{num_len}', ê³ ê°ë²ˆí˜¸êµ¬ì¡°='{struct}'")
    
    df = pd.DataFrame(data, columns=['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ', 'ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´', 'ê³ ê°ë²ˆí˜¸êµ¬ì¡°'])
    
    # ============ ë””ë²„ê¹… ì •ë³´ ì¶œë ¥ ============
    print("\n" + "="*80)
    print("ğŸ“Š Google Sheets ë°ì´í„° ë¡œë”© ê²°ê³¼")
    print("="*80)
    print(f"ì „ì²´ ì½ì€ í–‰ ìˆ˜: {len(all_values)-1}ê°œ")
    print(f"âœ… ìœ íš¨í•œ ê³„ì •ëª…: {len(df)}ê°œ")
    print(f"âŒ í•„í„°ë§ëœ í–‰: {len(skipped)}ê°œ")
    print(f"\nì»¬ëŸ¼ ì¸ë±ìŠ¤: ê³„ì •ëª…={idx_account}, ì„œë¹„ìŠ¤ì½”ë“œ={idx_service}, ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´={idx_len}, ê³ ê°ë²ˆí˜¸êµ¬ì¡°={idx_struct}")
    
    if skipped:
        print(f"\n{'='*80}")
        print(f"âŒ í•„í„°ë§ëœ í–‰ ëª©ë¡ ë° ì‚¬ìœ  ({len(skipped)}ê°œ)")
        print(f"{'='*80}")
        
        # ì‚¬ìœ ë³„ë¡œ ë¶„ë¥˜
        reason_no_account = []
        reason_no_service = []
        reason_length_mismatch = []
        reason_incomplete = []
        reason_invalid_numlen = []
        
        for s in skipped:
            if "ê³„ì •ëª…=''" in s and "ì„œë¹„ìŠ¤ì½”ë“œ=''" not in s:
                reason_no_account.append(s)
            elif "ì„œë¹„ìŠ¤ì½”ë“œ=''" in s:
                reason_no_service.append(s)
            elif "ê¸¸ì´ ë¶ˆì¼ì¹˜" in s:
                reason_length_mismatch.append(s)
            elif "ìˆ«ìê°€ ì•„ë‹˜" in s:
                reason_invalid_numlen.append(s)
            else:
                reason_incomplete.append(s)
        
        if reason_no_account:
            print(f"\n[ê³„ì •ëª… ì—†ìŒ] ({len(reason_no_account)}ê°œ)")
            for s in reason_no_account:
                print(f"  {s}")
        
        if reason_no_service:
            print(f"\n[ì„œë¹„ìŠ¤ì½”ë“œ ì—†ìŒ] ({len(reason_no_service)}ê°œ)")
            for s in reason_no_service:
                print(f"  {s}")
        
        if reason_length_mismatch:
            print(f"\n[ê³ ê°ë²ˆí˜¸êµ¬ì¡° ê¸¸ì´ ë¶ˆì¼ì¹˜] ({len(reason_length_mismatch)}ê°œ)")
            for s in reason_length_mismatch:
                print(f"  {s}")
        
        if reason_invalid_numlen:
            print(f"\n[ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ í˜•ì‹ ì˜¤ë¥˜] ({len(reason_invalid_numlen)}ê°œ)")
            for s in reason_invalid_numlen:
                print(f"  {s}")
        
        if reason_incomplete:
            print(f"\n[í•„ë“œ ëˆ„ë½] ({len(reason_incomplete)}ê°œ)")
            for s in reason_incomplete:
                print(f"  {s}")
    
    print(f"\n{'='*80}\n")
    return df

# ì‚¬ìš© ì˜ˆì‹œ
sheet_url = "https://docs.google.com/spreadsheets/d/10XO7o99fYr4e_I_etJF3_eCFa2_dsDs2egSWeu1GAls/edit#gid=679649875"
credentials_path = r"C:\ì œí’ˆë“±ë¡\gcp9304-4410543fedf2.json"
worksheet_name = "INí˜•ì‹"

df = read_google_sheet(sheet_url, credentials_path, worksheet_name)

# "ê³„ì •ëª…"ê³¼ "ì„œë¹„ìŠ¤ì½”ë“œ" ì»¬ëŸ¼ë§Œ ì¶œë ¥ (ë””ë²„ê·¸ìš©)
# print(df[['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ']])

# =====================
# ğŸ“Œ GUI êµ¬ì„± (Tkinter)
# =====================
window = tk.Tk()
window.title("ì„í¬íŠ¸ì²´ì»¤ (v251029)")
window.geometry("1000x600")

# ì•„ì´ì½˜ ì„¤ì •
try:
    # exeë¡œ ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸
    if getattr(sys, 'frozen', False):
        # exeë¡œ ì‹¤í–‰ ì¤‘: _MEIPASS ê²½ë¡œ ì‚¬ìš©
        icon_path = os.path.join(sys._MEIPASS, 'istec_icon.ico')
    else:
        # ì¼ë°˜ Python ì‹¤í–‰: í˜„ì¬ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ ì‚¬ìš©
        script_dir = os.path.dirname(os.path.abspath(__file__))
        icon_path = os.path.join(script_dir, 'istec_icon.ico')
    
    if os.path.exists(icon_path):
        window.iconbitmap(icon_path)
except Exception as e:
    # ì•„ì´ì½˜ ë¡œë“œ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
    pass

# â–¶ ê³„ì •ëª… ì½¤ë³´ë°•ìŠ¤ í”„ë ˆì„
site_frame = tk.Frame(window)
site_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

site_label = tk.Label(site_frame, text="ê³„ì •ëª… ì„ íƒ:")
site_label.pack(side=tk.LEFT)

# DB ìƒíƒœ í‘œì‹œ ë¼ë²¨ (ê³„ì •ëª… ì˜†ì—)
default_db = ACCOUNT_DB_CONFIGS.get('ê²½ë¶í¬í•­', {'host': 'N/A', 'port': 'N/A'})
db_status_label = tk.Label(window, text=f"ğŸŒ í˜„ì¬ DB: {default_db['host']}:{default_db['port']} (ê²½ë¶í¬í•­)", fg='#4CAF50', font=('Arial', 9))
db_status_label.pack(fill=tk.X, padx=10, pady=(5, 0))

exclude_accounts = ['ë‚˜ë¼ì¥í„°', 'ë†ì´Œê³µì‚¬', 'ë¡œìš°ë¦¬ìŠ¤', '']
filtered_df = df[~df['ê³„ì •ëª…'].isin(exclude_accounts)].copy()
filtered_df = filtered_df.sort_values('ê³„ì •ëª…').reset_index(drop=True)

# ë””ë²„ê¹…: ê³„ì •ëª… ëª©ë¡ ì¶œë ¥
print(f"[DEBUG] ë¡œë“œëœ ê³„ì •ëª… ê°œìˆ˜: {len(filtered_df)}")
print(f"[DEBUG] ê³„ì •ëª… ëª©ë¡:\n{filtered_df['ê³„ì •ëª…'].tolist()}")

# ì „ì²´ ê³„ì •ëª… ëª©ë¡ ì €ì¥ (ê²€ìƒ‰ìš©)
all_account_names = list(filtered_df['ê³„ì •ëª…'])

# ê³„ì •ëª… ì…ë ¥ì„ ìœ„í•œ í”„ë ˆì„ (ìë™ì™„ì„±ìš©)
account_autocomplete_frame = tk.Frame(site_frame)
account_autocomplete_frame.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))

# ê³„ì •ëª… ì…ë ¥ì°½ (Entry ì‚¬ìš©)
site_entry = tk.Entry(account_autocomplete_frame)
site_entry.pack(fill=tk.X)

# ìë™ì™„ì„± ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ (ì²˜ìŒì—” ìˆ¨ê¹€)
site_listbox = tk.Listbox(account_autocomplete_frame, height=8, fg='black', selectbackground='#2196F3')
site_listbox.pack_forget()  # ì²˜ìŒì—” ìˆ¨ê¹€

# ì„ íƒëœ ê³„ì •ëª… ì €ì¥ ë³€ìˆ˜
selected_account = tk.StringVar()

# ê³„ì •ëª… ìë™ì™„ì„± + ì‹¤ì‹œê°„ ê²€ìƒ‰ + ë™ì  í•„í„°ë§ ê¸°ëŠ¥
def update_autocomplete(event=None):
    """íƒ€ì´í•‘í•  ë•Œë§ˆë‹¤ ì‹¤ì‹œê°„ìœ¼ë¡œ í•„í„°ë§ëœ ë¦¬ìŠ¤íŠ¸ í‘œì‹œ"""
    # íŠ¹ìˆ˜ í‚¤ ì²˜ë¦¬
    if event:
        if event.keysym == 'Down':
            # ì•„ë˜ í™”ì‚´í‘œ: ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ë¡œ í¬ì»¤ìŠ¤ ì´ë™
            if site_listbox.size() > 0:
                site_listbox.pack(fill=tk.BOTH, expand=True)
                site_listbox.focus()
                site_listbox.selection_clear(0, tk.END)
                site_listbox.selection_set(0)
                site_listbox.see(0)
            return 'break'
        elif event.keysym == 'Escape':
            # ESC: ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ ìˆ¨ê¸°ê¸°
            site_listbox.pack_forget()
            return 'break'
        elif event.keysym in ['Return', 'Tab']:
            # Enter/Tab ì²˜ë¦¬ëŠ” ë³„ë„ í•¨ìˆ˜ì—ì„œ
            return
        elif event.keysym in ['Up', 'Left', 'Right', 'Shift_L', 'Shift_R', 'Control_L', 'Control_R']:
            return
    
    # í˜„ì¬ ì…ë ¥ëœ í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
    typed_text = site_entry.get()
    
    # ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    site_listbox.delete(0, tk.END)
    
    if typed_text == '':
        # ì…ë ¥ì´ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ëª©ë¡ í‘œì‹œ
        for name in all_account_names:
            # ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ìˆëŠ” ê³„ì •ëª…ì€ â˜… ë§ˆì»¤ ì¶”ê°€
            if name in ACCOUNT_DB_CONFIGS:
                site_listbox.insert(tk.END, f"â˜… {name}")
            else:
                site_listbox.insert(tk.END, name)
    else:
        # ì…ë ¥ëœ í…ìŠ¤íŠ¸ë¥¼ í¬í•¨í•˜ëŠ” ê³„ì •ëª…ë§Œ í•„í„°ë§
        typed_lower = typed_text.lower()
        filtered = [name for name in all_account_names if typed_lower in name.lower()]
        for name in filtered:
            # ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ìˆëŠ” ê³„ì •ëª…ì€ â˜… ë§ˆì»¤ ì¶”ê°€
            if name in ACCOUNT_DB_CONFIGS:
                site_listbox.insert(tk.END, f"â˜… {name}")
            else:
                site_listbox.insert(tk.END, name)
    
    # í•„í„°ë§ ê²°ê³¼ê°€ ìˆìœ¼ë©´ ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ í‘œì‹œ
    if site_listbox.size() > 0:
        site_listbox.pack(fill=tk.BOTH, expand=True)
    else:
        site_listbox.pack_forget()

def on_account_enter(event):
    """Enter í‚¤: ì²« ë²ˆì§¸ í•­ëª© ì„ íƒ ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ì—ì„œ ì„ íƒëœ í•­ëª© ì ìš©"""
    if site_listbox.winfo_viewable() and site_listbox.curselection():
        # ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ì—ì„œ ì„ íƒëœ í•­ëª©
        selection = site_listbox.get(site_listbox.curselection())
        # â˜… ë§ˆì»¤ ì œê±°
        selection = selection.replace('â˜… ', '')
        site_entry.delete(0, tk.END)
        site_entry.insert(0, selection)
        selected_account.set(selection)
        site_listbox.pack_forget()
    elif site_listbox.size() > 0:
        # ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ ì²« ë²ˆì§¸ í•­ëª©
        first_item = site_listbox.get(0)
        # â˜… ë§ˆì»¤ ì œê±°
        first_item = first_item.replace('â˜… ', '')
        site_entry.delete(0, tk.END)
        site_entry.insert(0, first_item)
        selected_account.set(first_item)
        site_listbox.pack_forget()
    return 'break'

def on_listbox_select(event):
    """ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ì—ì„œ í•­ëª© í´ë¦­ ì‹œ"""
    if site_listbox.curselection():
        selection = site_listbox.get(site_listbox.curselection())
        # â˜… ë§ˆì»¤ ì œê±°
        selection = selection.replace('â˜… ', '')
        site_entry.delete(0, tk.END)
        site_entry.insert(0, selection)
        selected_account.set(selection)
        site_listbox.pack_forget()
        site_entry.focus()
        # ê³„ì • ì •ë³´ í‘œì‹œ
        window.after(100, show_account_info)
        # DB ì„¤ì •ì´ ìˆëŠ” ê³„ì •ë§Œ ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸
        if selection.replace('â˜… ', '') in ACCOUNT_DB_CONFIGS:
            window.after(500, test_db_connection)

def on_listbox_key(event):
    """ë¦¬ìŠ¤íŠ¸ë°•ìŠ¤ì—ì„œ í‚¤ ì…ë ¥ ì²˜ë¦¬"""
    if event.keysym == 'Return':
        on_listbox_select(event)
        return 'break'
    elif event.keysym == 'Escape':
        site_listbox.pack_forget()
        site_entry.focus()
        return 'break'

# ê³„ì •ëª… ë³€ê²½ ê°ì§€ (ì„ íƒ ì‹œ ì •ë³´ íŒì—… ë° DB ì„¤ì • ë³€ê²½)
def show_account_info():
    """ì„ íƒëœ ê³„ì •ëª…ì˜ ìƒì„¸ ì •ë³´ í‘œì‹œ ë° DB ì„¤ì • ìë™ ë³€ê²½"""
    selected_name = site_entry.get()
    if not selected_name:
        return
    
    # filtered_dfì—ì„œ ì„ íƒëœ ê³„ì •ëª… ì°¾ê¸°
    matches = filtered_df[filtered_df['ê³„ì •ëª…'] == selected_name]
    if not matches.empty:
        account_name = matches.iloc[0]['ê³„ì •ëª…']
        service_code = matches.iloc[0]['ì„œë¹„ìŠ¤ì½”ë“œ']
        num_len = matches.iloc[0]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´']
        struct = matches.iloc[0]['ê³ ê°ë²ˆí˜¸êµ¬ì¡°']
        
        # DB ì„¤ì • í™•ì¸ ë° í‘œì‹œ
        db_config = get_db_config(account_name)
        
        if db_config is None:
            # ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ì—†ëŠ” ê³„ì •
            db_info = f"\n\n[DB ì„¤ì •]\nâŒ ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ"
            db_status_label.config(
                text=f"âš ï¸ '{account_name}' - DB ë„¤íŠ¸ì›Œí¬ ì •ë³´ ì—†ìŒ",
                fg='#F44336'
            )
        else:
            # ë„¤íŠ¸ì›Œí¬ ì •ë³´ê°€ ìˆëŠ” ê³„ì •
            db_info = f"\n\n[DB ì„¤ì •]\nHost: {db_config['host']}\nPort: {db_config['port']}"
            if account_name == 'ì¶©ë‚¨íƒœì•ˆ':
                db_status_label.config(
                    text=f"ğŸŒ í˜„ì¬ DB: {db_config['host']}:{db_config['port']} (ì¶©ë‚¨íƒœì•ˆ)",
                    fg='#FF5722'
                )
            elif account_name == 'ê²½ë¶í¬í•­':
                db_status_label.config(
                    text=f"ğŸŒ í˜„ì¬ DB: {db_config['host']}:{db_config['port']} (ê²½ë¶í¬í•­)",
                    fg='#4CAF50'
                )
            else:
                db_status_label.config(
                    text=f"ğŸŒ í˜„ì¬ DB: {db_config['host']}:{db_config['port']} ({account_name})",
                    fg='#2196F3'
                )
        
        messagebox.showinfo(
            "ì„ íƒí•œ ê³„ì •",
            f"ê³„ì •ëª…: {account_name}\nì„œë¹„ìŠ¤ì½”ë“œ: {service_code}\nìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´: {num_len}\nê³ ê°ë²ˆí˜¸êµ¬ì¡°: {struct}{db_info}"
        )

# Enter í‚¤ë¡œ ì„ íƒ ì‹œ ì •ë³´ í‘œì‹œ ë° DB ì—°ê²° í…ŒìŠ¤íŠ¸ ì¶”ê°€
original_on_account_enter = on_account_enter
def on_account_enter_with_info(event):
    result = original_on_account_enter(event)
    # Enterë¡œ ì„ íƒ ì™„ë£Œ í›„ ì •ë³´ í‘œì‹œ
    window.after(100, show_account_info)
    # DB ì„¤ì •ì´ ìˆëŠ” ê³„ì •ë§Œ ìë™ ì—°ê²° í…ŒìŠ¤íŠ¸
    selected_name = site_entry.get().strip()
    if selected_name in ACCOUNT_DB_CONFIGS:
        window.after(500, test_db_connection)
    return result

# ì´ë²¤íŠ¸ ë°”ì¸ë”©
site_entry.bind('<KeyRelease>', update_autocomplete)
site_entry.bind('<Return>', on_account_enter_with_info)
site_listbox.bind('<Double-Button-1>', on_listbox_select)
site_listbox.bind('<Return>', on_listbox_key)
site_listbox.bind('<Escape>', on_listbox_key)

# ê¸°ë³¸ê°’ "ê²½ë¶í¬í•­" ì„¤ì •
try:
    site_entry.insert(0, 'ê²½ë¶í¬í•­')
    selected_account.set('ê²½ë¶í¬í•­')
except Exception:
    pass

# â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ì…ë ¥ í”„ë ˆì„
company_frame = tk.Frame(window)
company_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

company_label = tk.Label(company_frame, text="ì†Œì†/ë‹¨ë§íšŒì‚¬ (ì‹­ì§„ìˆ˜):")
company_label.pack(side=tk.LEFT)

company_entry = tk.Entry(company_frame, width=20)
company_entry.pack(side=tk.LEFT, padx=(5, 0))
company_entry.insert(0, "6")  # ê¸°ë³¸ê°’ 6

# â–¶ DB ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í”„ë ˆì„
db_password_frame = tk.Frame(window)
db_password_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

db_password_label = tk.Label(db_password_frame, text="DB ë¹„ë°€ë²ˆí˜¸:")
db_password_label.pack(side=tk.LEFT)

db_password_entry = tk.Entry(db_password_frame, width=20, show='*')
db_password_entry.pack(side=tk.LEFT, padx=(5, 0))
db_password_entry.insert(0, "mars@icbm")  # ê¸°ë³¸ê°’ ì„¤ì •

# â–¶ ë§¤í•‘ ì¡°íšŒ ì…ë ¥ í”„ë ˆì„
mapping_frame = tk.Frame(window)
mapping_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

mapping_label = tk.Label(mapping_frame, text="ë§¤í•‘ ê´€ë¦¬ ì…ë ¥ì°½:\n  ì¡°íšŒ/í•´ì œ/ì›ë³µ: ìˆ˜ìš©ê°€ë²ˆí˜¸ ë˜ëŠ” ë‹¨ë§ì£¼ë²ˆí˜¸\n  ìƒì„±: ìˆ˜ìš©ê°€ë²ˆí˜¸,ë‹¨ë§ì£¼ë²ˆí˜¸ (ì˜ˆ: 2-001302290000,01236564855)")
mapping_label.pack(anchor=tk.W)

mapping_input_frame = tk.Frame(mapping_frame)
mapping_input_frame.pack(fill=tk.BOTH, expand=True)

mapping_search_text = tk.Text(mapping_input_frame, height=5, width=60)
mapping_search_text.pack(side=tk.LEFT, padx=(0, 5))

mapping_scrollbar = tk.Scrollbar(mapping_input_frame, command=mapping_search_text.yview)
mapping_scrollbar.pack(side=tk.LEFT, fill=tk.Y)
mapping_search_text.config(yscrollcommand=mapping_scrollbar.set)

# ë§¤í•‘ ê´€ë¦¬ ë²„íŠ¼ í”„ë ˆì„
mapping_buttons_frame = tk.Frame(mapping_frame)
mapping_buttons_frame.pack(pady=(5, 0))

mapping_search_btn = tk.Button(mapping_buttons_frame, text="ì¡°íšŒ", command=search_mapping, bg='#2196F3', fg='white', padx=15, pady=5)
mapping_search_btn.pack(side=tk.LEFT, padx=(0, 5))

mapping_create_btn = tk.Button(mapping_buttons_frame, text="ë§¤í•‘ ìƒì„±", command=create_mapping, bg='#4CAF50', fg='white', padx=15, pady=5)
mapping_create_btn.pack(side=tk.LEFT, padx=5)

mapping_unlink_btn = tk.Button(mapping_buttons_frame, text="ë§¤í•‘í•´ì œ", command=unlink_mapping, bg='#F44336', fg='white', padx=15, pady=5)
mapping_unlink_btn.pack(side=tk.LEFT, padx=5)

mapping_restore_btn = tk.Button(mapping_buttons_frame, text="ë§¤í•‘ì›ë³µ", command=restore_mapping, bg='#FF9800', fg='white', padx=15, pady=5)
mapping_restore_btn.pack(side=tk.LEFT, padx=5)

# â–¶ ë²„íŠ¼ êµ¬ì„±
button_frame = tk.Frame(window)
button_frame.pack(pady=10)

# ë¡œê·¸ ì´ˆê¸°í™” í•¨ìˆ˜
def clear_log():
    """ê²°ê³¼ ë¡œê·¸ ì´ˆê¸°í™”"""
    result_text.config(state=tk.NORMAL)
    result_text.delete(1.0, tk.END)
    result_text.insert(tk.END, f"ğŸ“‹ ë¡œê·¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
    result_text.config(state=tk.DISABLED)

clear_log_btn = tk.Button(button_frame, text="ë¡œê·¸ ì´ˆê¸°í™”", command=clear_log, bg='#9E9E9E', fg='white', padx=10)
clear_log_btn.pack(side=tk.LEFT, padx=5)

db_test_btn = tk.Button(button_frame, text="DB ì—°ê²° í…ŒìŠ¤íŠ¸", command=test_db_connection, bg='#4CAF50', fg='white', padx=10)
db_test_btn.pack(side=tk.LEFT, padx=5)

excel_btn = tk.Button(button_frame, text="ì—‘ì…€ íŒŒì¼ ì„ íƒ ë° SQL ë³€í™˜", command=generate_sql_from_excel, padx=10)
excel_btn.pack(side=tk.LEFT, padx=5)

# â–¶ ê²°ê³¼ ì¶œë ¥ í”„ë ˆì„
frame = tk.Frame(window)
frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

# â–¶ ê°€ë¡œ ìŠ¤í¬ë¡¤ë°”
x_scrollbar = tk.Scrollbar(frame, orient=tk.HORIZONTAL)
x_scrollbar.pack(side=tk.BOTTOM, fill=tk.X)

# â–¶ ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°”
y_scrollbar = tk.Scrollbar(frame)
y_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

# â–¶ ê²°ê³¼ ì¶œë ¥ í…ìŠ¤íŠ¸ì°½ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
result_text = tk.Text(frame, wrap=tk.NONE, xscrollcommand=x_scrollbar.set, yscrollcommand=y_scrollbar.set)
result_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

x_scrollbar.config(command=result_text.xview)
y_scrollbar.config(command=result_text.yview)

# â–¶ í”„ë¡œê·¸ë¨ ì‹œì‘ ì‹œ ìë™ìœ¼ë¡œ DB ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (500ms í›„)
window.after(500, test_db_connection)

# â–¶ ë©”ì¸ ë£¨í”„ ì‹¤í–‰
window.mainloop()

