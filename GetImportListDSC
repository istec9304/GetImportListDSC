# =============================================
# ğŸ“Œ ì„í¬íŠ¸ì²´ì»¤ (v250723)
# ì‘ì„±ì: ì„œê¸°ëŒ€
# ëª©ì : ìˆ˜ìš©ê°€ ë‹¨ë§ê¸° ë“±ë¡ìš© ì—‘ì…€ íŒŒì¼ì„ SQL VALUES êµ¬ë¬¸ìœ¼ë¡œ ìë™ ë³€í™˜
# ì£¼ìš” ê¸°ëŠ¥:
#   - ì—‘ì…€ íŒŒì¼ ì„ íƒ ì°½ ì œê³µ
#   - ì •í•´ì§„ 20ê°œ ì»¬ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„° íŒŒì‹±
#   - ì„±ê³µ/ì‹¤íŒ¨ í•­ëª© ìˆ˜ ì§‘ê³„
#   - ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë° SQL VALUES êµ¬ë¬¸ ì¶œë ¥
#   - ê¸´ í…ìŠ¤íŠ¸ë¥¼ ê°€ë¡œ/ì„¸ë¡œ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ ì¶œë ¥
#   - ìœ íš¨ì„± ê²€ì‚¬ CASE ë„˜ë²„ë§ ì§€ì›
#   - í”„ë¡œê·¸ë¨ ë²„ì „: v250723
# =============================================

import gspread
import pandas as pd
import tkinter as tk
from tkinter import filedialog, messagebox
from datetime import datetime
from tkinter import ttk

# ğŸ“Œ ì—‘ì…€ ì»¬ëŸ¼ëª… ì •ì˜ (20ê°œ í•­ëª©)
COLUMNS = [
    'ìˆ˜ìš©ê°€ëª…', 'ìˆ˜ìš©ê°€ë²ˆí˜¸', 'êµ¬ì£¼ì†Œ', 'ì‹ ì£¼ì†Œ', 'ê²½ë„', 'ìœ„ë„', 'ì—…ì¢…', 'ì†Œì†',
    'ë¸”ë¡', 'ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸', 'ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„', 'ê²€ì¹¨ì›', 'ê²€ì¹¨ì¼', 'ê³„ëŸ‰ê¸°ë²ˆí˜¸',
    'êµ¬ê²½', 'í†µì‹ ', 'ë‹¨ë§ ë¶€ë²ˆí˜¸', 'ë‹¨ë§ ì£¼ë²ˆí˜¸', 'ë‹¨ë§ íšŒì‚¬', 'ë‹¨ë§ ì„¤ì¹˜ì¼'
]

# ğŸ“Œ ì—‘ì…€ íŒŒì¼ì„ ì½ê³  SQL VALUES êµ¬ë¬¸ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
def generate_sql_from_excel():
    # íŒŒì¼ ì„ íƒ ì°½ ì—´ê¸°
    file_path = filedialog.askopenfilename(title="ì—‘ì…€ íŒŒì¼ ì„ íƒ", filetypes=[("Excel files", "*.xlsx *.xls")])
    if not file_path:
        messagebox.showwarning("íŒŒì¼ ì„ íƒ", "íŒŒì¼ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì½¤ë³´ë°•ìŠ¤ì—ì„œ ì„ íƒëœ ê³„ì •ëª…ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°€ì ¸ì˜¤ê¸°
    idx = site_combobox.current()
    if idx < 0:
        messagebox.showwarning("ê³„ì •ëª… ì„ íƒ", "ë¨¼ì € ê³„ì •ëª…ì„ ì„ íƒí•˜ì„¸ìš”.")
        return
    try:
        selected_num_len = int(filtered_df.iloc[idx]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´'])
    except Exception:
        messagebox.showerror("ê³„ì •ëª… ì˜¤ë¥˜", "ì„ íƒí•œ ê³„ì •ì˜ ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´ ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        return

    # â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ ê°€ì ¸ì˜¤ê¸°
    company_value = company_entry.get().strip()
    if not company_value:
        messagebox.showwarning("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.")
        return
    try:
        company_sq = int(company_value)
    except ValueError:
        messagebox.showerror("ì…ë ¥ ì˜¤ë¥˜", "ì†Œì†/ë‹¨ë§íšŒì‚¬ ê°’ì€ ì •ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.")
        return

    try:
        # ì—‘ì…€ ë°ì´í„°í”„ë ˆì„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ê³µë°± ì±„ì›€
        df = pd.read_excel(file_path, dtype=str).fillna('')
        df = df.iloc[:, 1:1+len(COLUMNS)]  # ì²« ì—´ ì œì™¸ í›„ 20ì—´ë§Œ ì„ íƒ
        df.columns = COLUMNS

        # â–¶ ì¤‘ë³µ ìˆ˜ìš©ê°€ë²ˆí˜¸ ë¯¸ë¦¬ ì§‘ê³„
        admin_no_counts = df['ìˆ˜ìš©ê°€ë²ˆí˜¸'].value_counts()
        duplicated_admin_nos = set(admin_no_counts[admin_no_counts > 1].index)

        values_list = []
        success_count = 0
        fail_count = 0
        success_admin_no_list = []  # ì„±ê³µí•œ ìˆ˜ìš©ê°€ë²ˆí˜¸ ì €ì¥

        # ê° í–‰ ë°˜ë³µ ì²˜ë¦¬
        validation_cases = [
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ë²ˆí˜¸']) == selected_num_len, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ê¸¸ì´ ë¶ˆì¼ì¹˜"),
            ("ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ ê²€ì‚¬", lambda row: row['ìˆ˜ìš©ê°€ë²ˆí˜¸'] not in duplicated_admin_nos, "ìˆ˜ìš©ê°€ë²ˆí˜¸ ì¤‘ë³µ"),
            ("ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ ê¸¸ì´ ê²€ì‚¬", lambda row: len(row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸']) < 14, "ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸ 13ìë¦¬ ì´ˆê³¼"),
            
        ]

        for idx_row, row in df.iterrows():
            try:
                for case_num, (desc, check_func, err_msg) in enumerate(validation_cases, 1):
                    if not check_func(row):
                        raise ValueError(f"[CASE #{case_num}] {err_msg} (ê°’: {row['ìˆ˜ìš©ê°€ë²ˆí˜¸']})")
                # ìˆ«ì ë³€í™˜ì´ í•„ìš”í•œ ì»¬ëŸ¼ì— ëŒ€í•´ ê°’ì´ ë¹„ì–´ìˆìœ¼ë©´ ì˜ˆì™¸ ë°œìƒ
                def safe_float(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return float(val)
                def safe_int(val, col):
                    if val == '':
                        raise ValueError(f"{col} ê°’ì´ ë¹„ì–´ìˆìŒ")
                    return int(float(val))
                values = (
                    row['ìˆ˜ìš©ê°€ëª…'],
                    row['ìˆ˜ìš©ê°€ë²ˆí˜¸'],
                    row['êµ¬ì£¼ì†Œ'],
                    row['ì‹ ì£¼ì†Œ'],
                    safe_float(row['ê²½ë„'], 'ê²½ë„'),
                    safe_float(row['ìœ„ë„'], 'ìœ„ë„'),
                    row['ì—…ì¢…'],
                    company_sq,
                    row['ë¸”ë¡'],
                    row['ìˆ˜ìš©ê°€ ì „í™”ë²ˆí˜¸'],
                    row['ìˆ˜ìš©ê°€ ëŒ€ìƒ ë…„ë„'],
                    row['ê²€ì¹¨ì›'],
                    safe_int(row['ê²€ì¹¨ì¼'], 'ê²€ì¹¨ì¼'),
                    row['ê³„ëŸ‰ê¸°ë²ˆí˜¸'],
                    safe_int(row['êµ¬ê²½'], 'êµ¬ê²½'),
                    row['í†µì‹ '],
                    row['ë‹¨ë§ ë¶€ë²ˆí˜¸'],
                    row['ë‹¨ë§ ì£¼ë²ˆí˜¸'],
                    company_sq,
                    f"{pd.to_datetime(row['ë‹¨ë§ ì„¤ì¹˜ì¼']).date()}"
                )
                # SQL VALUES ë¬¸ìì—´ í¬ë§·íŒ…
                formatted = "('{}', '{}', '{}', '{}', {}, {}, '{}', {}, '{}', '{}', '{}', '{}', {}, '{}', {}, '{}', '{}', '{}', {}, '{}'::timestamp)".format(*values)
                values_list.append(formatted)
                success_admin_no_list.append(row['ìˆ˜ìš©ê°€ë²ˆí˜¸'])
                success_count += 1
            except Exception as e:
                values_list.append(f"-- [ERROR #{idx_row+1}] {e}")
                fail_count += 1

        # ê²°ê³¼ ì¶œë ¥ì°½ ì´ˆê¸°í™” ë° ê²°ê³¼ ì‚½ì…
        result_text.config(state=tk.NORMAL)
        result_text.delete(1.0, tk.END)

        # âœ… ìˆ˜ìš©ê°€ë²ˆí˜¸ ëª©ë¡ ë¨¼ì € ì¶œë ¥
        result_text.insert(tk.END, "-- âœ… ì„í¬íŠ¸ì „ ì¡°íšŒí•  ìˆ˜ìš©ê°€ëª©ë¡\n")
        result_text.insert(tk.END, ",\n".join(f"'{x}'" for x in success_admin_no_list) + "\n\n")

        # âœ… ì„±ê³µ/ì‹¤íŒ¨ í†µê³„ ì¶œë ¥
        result_text.insert(tk.END, f"-- ì´ {len(df)}ê°œ ì¤‘ {success_count}ê°œ ì„±ê³µ, {fail_count}ê°œ ì‹¤íŒ¨\n\n")

        # âœ… SQL VALUES ì¶œë ¥
        result_text.insert(tk.END, ",\n".join(values_list))
        result_text.config(state=tk.DISABLED)

    except Exception as e:
        messagebox.showerror("ì—ëŸ¬ ë°œìƒ", str(e))


def read_google_sheet(sheet_url, credentials_path, worksheet_name):
    gc = gspread.service_account(filename=credentials_path)
    sh = gc.open_by_url(sheet_url)
    worksheet = sh.worksheet(worksheet_name)
    all_values = worksheet.get_all_values()
    # ì²« í–‰ì—ì„œ ì›í•˜ëŠ” ì»¬ëŸ¼ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
    header = all_values[0]
    idx_account = header.index('ê³„ì •ëª…')
    idx_service = header.index('ì„œë¹„ìŠ¤ì½”ë“œ')
    idx_len = header.index('ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´')
    idx_struct = header.index('ê³ ê°ë²ˆí˜¸êµ¬ì¡°')
    # ì›í•˜ëŠ” ì»¬ëŸ¼ë§Œ ì¶”ì¶œ
    data = [
        [row[idx_account], row[idx_service], row[idx_len], row[idx_struct]]
        for row in all_values[1:]
        if row[idx_account] and row[idx_service]
    ]
    df = pd.DataFrame(data, columns=['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ', 'ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´', 'ê³ ê°ë²ˆí˜¸êµ¬ì¡°'])
    return df

# ì‚¬ìš© ì˜ˆì‹œ
sheet_url = "https://docs.google.com/spreadsheets/d/10XO7o99fYr4e_I_etJF3_eCFa2_dsDs2egSWeu1GAls/edit#gid=679649875"
credentials_path = r"C:\ì œí’ˆë“±ë¡\gcp9304-4410543fedf2.json"
worksheet_name = "INí˜•ì‹"

df = read_google_sheet(sheet_url, credentials_path, worksheet_name)

# "ê³„ì •ëª…"ê³¼ "ì„œë¹„ìŠ¤ì½”ë“œ" ì»¬ëŸ¼ë§Œ ì¶œë ¥ (ë””ë²„ê·¸ìš©)
# print(df[['ê³„ì •ëª…', 'ì„œë¹„ìŠ¤ì½”ë“œ']])

# =====================
# ğŸ“Œ GUI êµ¬ì„± (Tkinter)
# =====================
window = tk.Tk()
window.title("ì„í¬íŠ¸ì²´ì»¤ (v240607)")
window.geometry("1000x600")

# â–¶ ê³„ì •ëª… ì½¤ë³´ë°•ìŠ¤ í”„ë ˆì„
site_frame = tk.Frame(window)
site_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

site_label = tk.Label(site_frame, text="ê³„ì •ëª… ì„ íƒ:")
site_label.pack(side=tk.LEFT)

exclude_accounts = ['ë‚˜ë¼ì¥í„°', 'ë†ì´Œê³µì‚¬', 'ë¡œìš°ë¦¬ìŠ¤', '']
filtered_df = df[~df['ê³„ì •ëª…'].isin(exclude_accounts)].copy()
filtered_df = filtered_df.sort_values('ê³„ì •ëª…').reset_index(drop=True)
site_combobox = ttk.Combobox(site_frame, values=list(filtered_df['ê³„ì •ëª…']), state="readonly")
site_combobox.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))

# ê¸°ë³¸ê°’ "ê²½ë¶í¬í•­" ì„¤ì •
try:
    default_idx = filtered_df[filtered_df['ê³„ì •ëª…'] == 'ê²½ë¶í¬í•­'].index[0]
    site_combobox.current(default_idx)
except (IndexError, KeyError):
    pass  # ê²½ë¶í¬í•­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì • ì•ˆ í•¨

# ê³„ì •ëª… ì„ íƒ ì‹œ 4ê°œ ì»¬ëŸ¼ ì •ë³´ íŒì—…
def on_site_select(event):
    idx = site_combobox.current()
    if idx >= 0:
        account_name = filtered_df.iloc[idx]['ê³„ì •ëª…']
        service_code = filtered_df.iloc[idx]['ì„œë¹„ìŠ¤ì½”ë“œ']
        num_len = filtered_df.iloc[idx]['ìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´']
        struct = filtered_df.iloc[idx]['ê³ ê°ë²ˆí˜¸êµ¬ì¡°']
        messagebox.showinfo(
            "ì„ íƒí•œ ê³„ì •",
            f"ê³„ì •ëª…: {account_name}\nì„œë¹„ìŠ¤ì½”ë“œ: {service_code}\nìˆ˜ìš©ê°€ë²ˆí˜¸ê¸¸ì´: {num_len}\nê³ ê°ë²ˆí˜¸êµ¬ì¡°: {struct}"
        )
site_combobox.bind('<<ComboboxSelected>>', on_site_select)

# â–¶ ì†Œì†/ë‹¨ë§íšŒì‚¬ ì…ë ¥ í”„ë ˆì„
company_frame = tk.Frame(window)
company_frame.pack(fill=tk.X, padx=10, pady=(10, 0))

company_label = tk.Label(company_frame, text="ì†Œì†/ë‹¨ë§íšŒì‚¬ (ì‹­ì§„ìˆ˜):")
company_label.pack(side=tk.LEFT)

company_entry = tk.Entry(company_frame, width=20)
company_entry.pack(side=tk.LEFT, padx=(5, 0))
company_entry.insert(0, "6")  # ê¸°ë³¸ê°’ 6

# â–¶ ë²„íŠ¼ êµ¬ì„±
btn = tk.Button(window, text="ì—‘ì…€ íŒŒì¼ ì„ íƒ ë° SQL ë³€í™˜", command=generate_sql_from_excel)
btn.pack(pady=10)

# â–¶ ê²°ê³¼ ì¶œë ¥ í”„ë ˆì„
frame = tk.Frame(window)
frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)

# â–¶ ê°€ë¡œ ìŠ¤í¬ë¡¤ë°”
x_scrollbar = tk.Scrollbar(frame, orient=tk.HORIZONTAL)
x_scrollbar.pack(side=tk.BOTTOM, fill=tk.X)

# â–¶ ì„¸ë¡œ ìŠ¤í¬ë¡¤ë°”
y_scrollbar = tk.Scrollbar(frame)
y_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)

# â–¶ ê²°ê³¼ ì¶œë ¥ í…ìŠ¤íŠ¸ì°½ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥)
result_text = tk.Text(frame, wrap=tk.NONE, xscrollcommand=x_scrollbar.set, yscrollcommand=y_scrollbar.set)
result_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)

x_scrollbar.config(command=result_text.xview)
y_scrollbar.config(command=result_text.yview)

# â–¶ ë©”ì¸ ë£¨í”„ ì‹¤í–‰
window.mainloop()

